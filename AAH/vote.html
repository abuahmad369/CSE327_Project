<!DOCTYPE html>
<html lang="bn">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CampusCast - ржнрзЛржЯ ржжрж┐ржи</title>
  <link rel="stylesheet" href="/assets/style.css" />
</head>
<body>
  <!-- Background -->
  <div class="hands-bg"></div>

  <div class="container">
    <!-- Header (same as others) -->
    <header class="site-header">
      <a href="index.html" class="logo" aria-label="CampusCast рж╣рзЛржоржкрзЗржЬрзЗ ржпрж╛ржи">
        <div class="logo-text">
          <span>CampusCast</span>
          <div class="logo-bars">
            <div class="bar"></div>
            <div class="bar alt"></div>
            <div class="bar"></div>
            <div class="bar alt"></div>
          </div>
        </div>
        <div class="logo-subtitle">ржмрж┐рж╢рзНржмржмрж┐ржжрзНржпрж╛рж▓рзЯ ржЗ-ржнрзЛржЯрж┐ржВ рж╕рж┐рж╕рзНржЯрзЗржо</div>
      </a>

      <nav class="site-nav">
        <a href="/login/login.html" class="nav-link">ржкрзНрж░рж╢рж╛рж╕ржХ</a>
        <a href="/login/login.html" class="nav-link">ржкрзНрж░рж╛рж░рзНржерзА</a>
        <a href="/voter.html" class="nav-link">ржнрзЛржЯрж╛рж░</a>
        <a href="public.html" class="nav-link">ржкрж╛ржмрж▓рж┐ржХ</a>
        <a class="login-btn" href="/login/login.html" role="button">рж▓ржЧржЗржи</a>
      </nav>
    </header>

    <!-- Main content -->
    <main class="main-content" style="gap:40px; align-items:flex-start;">
      <!-- Left info -->
      <section class="content" style="max-width:460px;">
        <span class="badge">ржнрзЛржЯ ржкрзНрж░ржжрж╛ржи</span>
        <h1 id="electionTitle">ржирж┐рж░рзНржмрж╛ржЪржирзЗрж░ рждржерзНржп рж▓рзЛржб рж╣ржЪрзНржЫрзЗ...</h1>
        <p class="description" id="electionDescription">
          ржирж┐рж░рзНржмрж╛ржЪржирзЗрж░ ржмрж┐рж╕рзНрждрж╛рж░рж┐ржд рждржерзНржп Supabase ржерзЗржХрзЗ рж▓рзЛржб ржХрж░рж╛ рж╣ржЪрзНржЫрзЗред ржЕржирзБржЧрзНрж░рж╣ ржХрж░рзЗ ржЕржкрзЗржХрзНрж╖рж╛ ржХрж░рзБржиред
        </p>

        <div class="ethereum-note" style="margin-top:12px;">
          <span class="ethereum-icon">тЪая╕П</span>
          ржкрзНрж░рждрж┐ржЯрж┐ ржирж┐рж░рзНржмрж╛ржЪржирзЗ ржорж╛рждрзНрж░ ржПржХржмрж╛рж░ ржнрзЛржЯ ржжрзЗржУрзЯрж╛ ржпрж╛ржмрзЗред ржнрзЛржЯ рж╕рж╛ржмржорж┐ржЯ ржХрж░рж╛рж░ ржкрж░ ржЖрж░ ржкрж░рж┐ржмрж░рзНрждржи ржХрж░рж╛ ржпрж╛ржмрзЗ ржирж╛ред
        </div>

        <p id="electionStatusText" style="margin-top:10px; font-size:14px; color:#4b5563;"></p>

        <button
          type="button"
          class="btn btn-secondary"
          style="margin-top:10px;"
          onclick="window.location.href='voter.html';"
        >
          ржбрзНржпрж╛рж╢ржмрзЛрж░рзНржбрзЗ ржлрж┐рж░рзЗ ржпрж╛ржи
        </button>
      </section>

      <!-- Right: vote form -->
      <section aria-label="ржкрзНрж░рж╛рж░рзНржерзА рждрж╛рж▓рж┐ржХрж╛" style="flex:1; max-width:520px;">
        <div
          style="
            background:#fff;
            border:1px solid var(--border);
            border-radius:14px;
            box-shadow:0 6px 18px rgba(0,0,0,0.08);
            padding:18px 18px 18px;
          "
        >
          <h2 style="font-size:18px; font-weight:800; margin:0 0 8px; color:var(--ink);">
            ржкрзНрж░рж╛рж░рзНржерзА рждрж╛рж▓рж┐ржХрж╛
          </h2>
          <p id="candidatesStatus" style="font-size:14px; margin-bottom:10px; color:var(--muted);">
            ржкрзНрж░рж╛рж░рзНржерзАрж░ рждржерзНржп рж▓рзЛржб рж╣ржЪрзНржЫрзЗ...
          </p>

          <form id="voteForm">
            <div id="candidatesList" style="display:flex; flex-direction:column; gap:8px;">
              <!-- JS will insert candidate cards -->
            </div>

            <p id="voteMessage" style="margin-top:10px; font-size:14px; color:crimson;"></p>

            <button
              id="submitBtn"
              type="submit"
              class="btn btn-primary"
              style="margin-top:12px; width:100%; text-align:center;"
            >
              ржнрзЛржЯ рж╕рж╛ржмржорж┐ржЯ ржХрж░рзБржи
            </button>
          </form>
        </div>
      </section>
    </main>

    <!-- Footer -->
    <footer class="features">
      <div class="feature">
        <div class="feature-icon">ЁЯз╛</div>
        <div class="feature-text">
          <h3>рж╕рзНржмржЪрзНржЫ ржкрзНрж░ржХрзНрж░рж┐рзЯрж╛</h3>
          <p>рж╕ржорж╕рзНржд рж░рзЗржХрж░рзНржб ржпрж╛ржЪрж╛ржЗржпрзЛржЧрзНржп ржУ ржирж┐рж░рзАржХрзНрж╖рж╛ржпрзЛржЧрзНржпред</p>
        </div>
      </div>
      <div class="feature">
        <div class="feature-icon">ЁЯФТ</div>
        <div class="feature-text">
          <h3>ржПржирзНржб ржЯрзБ ржПржирзНржб ржПржиржХрзНрж░рж┐ржкрж╢ржи</h3>
          <p>ржкрзНрж░рждрж┐ржЯрж┐ ржзрж╛ржкрзЗ ржЖржкржирж╛рж░ рждржерзНржп рж╕рзБрж░ржХрзНрж╖рж┐ржд ржерж╛ржХрзЗред</p>
        </div>
      </div>
      <div class="feature">
        <div class="feature-icon">тЪб</div>
        <div class="feature-text">
          <h3>ржжрзНрж░рзБржд ржУ ржХрж╛рж░рзНржпржХрж░</h3>
          <p>рж░рж┐рзЯрзЗрж▓ ржЯрж╛ржЗржорзЗ ржлрж▓рж╛ржлрж▓ ржжрзЗржЦрждрзЗ ржкрж╛рж░ржмрзЗржиред</p>
        </div>
      </div>

      <div class="nav-arrows">
        <button class="arrow-btn" aria-label="ржкрзВрж░рзНржмрзЗрж░ рж╕рзНрж▓рж╛ржЗржб">тА╣</button>
        <button class="arrow-btn" aria-label="ржкрж░ржмрж░рзНрждрзА рж╕рзНрж▓рж╛ржЗржб">тА║</button>
      </div>

      <div class="dots" aria-hidden="true">
        <span class="dot active"></span>
        <span class="dot"></span>
        <span class="dot"></span>
      </div>

      <div class="footer-credit">
        <p>┬й рзирзжрзирзл <strong>FourA</strong> - CampusCast</p>
      </div>
    </footer>
  </div>

  <!-- Supabase client -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
  <script>
    const SUPABASE_URL = "https://hgxjuxgxgbjjqxxvafhx.supabase.co";
    const SUPABASE_ANON_KEY = "sb_publishable_RqoNSHsQQOhs8dfL0OXsdA_TfeVyZcn";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const CC_CURRENT_USER_KEY = "cc_currentUser";
    const CC_VOTE_HISTORY_KEY = "cc_voteHistory";

    function getCurrentUser() {
      try {
        const raw = localStorage.getItem(CC_CURRENT_USER_KEY);
        return raw ? JSON.parse(raw) : null;
      } catch {
        return null;
      }
    }

    function requireVoterUser() {
      const user = getCurrentUser();
      if (!user || user.role !== "voter") {
        window.location.href = "/login/login.html";
        return null;
      }
      return user;
    }

    function getElectionIdFromUrl() {
      const params = new URLSearchParams(window.location.search);
      return params.get("election_id");
    }

    function saveVoteHistoryEntry(entry) {
      try {
        const raw = localStorage.getItem(CC_VOTE_HISTORY_KEY) || "[]";
        const list = JSON.parse(raw);
        list.push(entry);
        localStorage.setItem(CC_VOTE_HISTORY_KEY, JSON.stringify(list));
      } catch (e) {
        console.warn("failed to save local vote history:", e);
      }
    }

    (function initVotePage() {
      const user = requireVoterUser();
      if (!user) return;

      const electionId = getElectionIdFromUrl();
      const titleEl = document.getElementById("electionTitle");
      const descEl = document.getElementById("electionDescription");
      const statusTextEl = document.getElementById("electionStatusText");
      const candStatusEl = document.getElementById("candidatesStatus");
      const candListEl = document.getElementById("candidatesList");
      const voteForm = document.getElementById("voteForm");
      const voteMessageEl = document.getElementById("voteMessage");
      const submitBtn = document.getElementById("submitBtn");

      if (!electionId) {
        if (titleEl) titleEl.textContent = "ржнрзБрж▓ ржЗржЙржЖрж░ржПрж▓ - ржирж┐рж░рзНржмрж╛ржЪржирзЗрж░ ржЖржЗржбрж┐ ржкрж╛ржУржпрж╝рж╛ ржпрж╛ржпрж╝ржирж┐";
        if (candStatusEl) candStatusEl.textContent = "рж╕ржарж┐ржХ ржирж┐рж░рзНржмрж╛ржЪржирзЗрж░ рж▓рж┐ржЩрзНржХ ржжрж┐ржпрж╝рзЗ ржкрзБржирж░рж╛ржпрж╝ ржЪрзЗрж╖рзНржЯрж╛ ржХрж░рзБржиред";
        if (submitBtn) submitBtn.disabled = true;
        return;
      }

      let voterRow = null;
      let electionRow = null;
      let existingVote = null;
      let candidates = [];

      async function loadAll() {
        try {
          // 1) voter row (from voters table)
          const { data: voter, error: vErr } = await supabase
            .from("voters")
            .select("id, is_approved")
            .eq("user_id", user.id)
            .single();

          if (vErr) {
            throw new Error("ржнрзЛржЯрж╛рж░ ржкрзНрж░рзЛржлрж╛ржЗрж▓ ржкрж╛ржУржпрж╝рж╛ ржпрж╛ржпрж╝ржирж┐ред");
          }
          voterRow = voter;

          // 2) election row
          const { data: election, error: eErr } = await supabase
            .from("elections")
            .select("*")
            .eq("id", electionId)
            .single();

          if (eErr || !election) {
            throw new Error("ржирж┐рж░рзНржмрж╛ржЪржирзЗрж░ рждржерзНржп ржкрж╛ржУрзЯрж╛ ржпрж╛рзЯржирж┐ред");
          }
          electionRow = election;

          if (titleEl) titleEl.textContent = election.title || "ржирж┐рж░рзНржмрж╛ржЪржирзЗрж░ ржирж╛ржо ржкрж╛ржУрзЯрж╛ ржпрж╛рзЯржирж┐";
          if (descEl) {
            const desc = election.description || "ржПржЗ ржирж┐рж░рзНржмрж╛ржЪржирзЗрж░ ржЬржирзНржп ржХрзЛржирзЛ ржмрж┐ржмрж░ржг рж╕ржВрж░ржХрзНрж╖ржг ржХрж░рж╛ рж╣рзЯржирж┐ред";
            descEl.textContent = desc;
          }
          if (statusTextEl) {
            const st = election.status;
            let bnStatus = "ржЕржЬрж╛ржирж╛";
            if (st === "draft") bnStatus = "ржЦрж╕рзЬрж╛";
            else if (st === "scheduled") bnStatus = "рждрж╛рж▓рж┐ржХрж╛ржнрзБржХрзНржд";
            else if (st === "active") bnStatus = "ржЪрж▓ржорж╛ржи";
            else if (st === "closed") bnStatus = "рж╕ржорж╛ржкрзНржд";

            statusTextEl.textContent =
              "ржмрж░рзНрждржорж╛ржи рж╕рзНржЯрзНржпрж╛ржЯрж╛рж╕: " +
              bnStatus +
              (st !== "active" ? " (ржЪрж▓ржорж╛ржи ржирж┐рж░рзНржмрж╛ржЪржи ржирж╛ рж╣ржУрзЯрж╛рзЯ ржнрзЛржЯ ржжрзЗржУрзЯрж╛ ржпрж╛ржмрзЗ ржирж╛)" : "");
          }

          // 3) existing vote (votes table uses voter_id referencing voters.id)
          const { data: existing, error: exErr } = await supabase
            .from("votes")
            .select("id")
            .eq("election_id", electionId)
            .eq("voter_id", voterRow.id)
            .maybeSingle();

          if (exErr && exErr.code !== "PGRST116" && exErr.details !== "Results contain 0 rows") {
            console.warn("existing vote error:", exErr);
          }
          existingVote = existing || null;

          // 4) candidates (approved only)
          const { data: candRows, error: cErr } = await supabase
            .from("candidates")
            .select("id, user_id, symbol, manifesto, is_approved")
            .eq("election_id", electionId)
            .eq("is_approved", true);

          if (cErr) {
            throw new Error("ржкрзНрж░рж╛рж░рзНржерзАрж░ рждржерзНржп рж▓рзЛржб ржХрж░рждрзЗ рж╕ржорж╕рзНржпрж╛ рж╣ржпрж╝рзЗржЫрзЗред");
          }

          candidates = candRows || [];

          if (!candidates.length) {
            candStatusEl.textContent = "ржПржЗ ржирж┐рж░рзНржмрж╛ржЪржирзЗрж░ ржЬржирзНржп ржХрзЛржирзЛ ржЕржирзБржорзЛржжрж┐ржд ржкрзНрж░рж╛рж░рзНржерзА ржкрж╛ржУрзЯрж╛ ржпрж╛рзЯржирж┐ред";
          } else {
            candStatusEl.textContent = `ржорзЛржЯ ${candidates.length} ржЬржи ржкрзНрж░рж╛рж░рзНржерзА ржкрж╛ржУржпрж╝рж╛ ржЧрзЗржЫрзЗред`;
          }

          // also load user names for candidates
          if (candidates.length) {
            const userIds = candidates.map(c => c.user_id);
            const { data: candidateUsers, error: uErr } = await supabase
              .from("users")
              .select("id, name")
              .in("id", userIds);

            if (uErr) {
              console.warn("candidate users load error:", uErr);
            } else {
              const nameMap = {};
              (candidateUsers || []).forEach(u => {
                nameMap[u.id] = u.name || "ржирж╛ржо ржирзЗржЗ";
              });
              candidates = candidates.map(c => ({
                ...c,
                userName: nameMap[c.user_id] || "ржирж╛ржо ржирзЗржЗ"
              }));
            }
          }

          renderCandidates();
          updateFormAvailability();
        } catch (err) {
          console.error(err);
          if (candStatusEl) candStatusEl.textContent = err.message || "ржбрзЗржЯрж╛ рж▓рзЛржб ржХрж░рждрзЗ рж╕ржорж╕рзНржпрж╛ рж╣ржпрж╝рзЗржЫрзЗред";
          if (submitBtn) submitBtn.disabled = true;
        }
      }

      function renderCandidates() {
        candListEl.innerHTML = "";
        if (!candidates.length) return;

        candidates.forEach(c => {
          const wrapper = document.createElement("label");
          wrapper.style.display = "flex";
          wrapper.style.gap = "10px";
          wrapper.style.alignItems = "flex-start";
          wrapper.style.padding = "8px 10px";
          wrapper.style.borderRadius = "10px";
          wrapper.style.border = "1px solid var(--border)";
          wrapper.style.background = "#f9fafb";
          wrapper.style.cursor = "pointer";

          const radio = document.createElement("input");
          radio.type = "radio";
          radio.name = "candidate";
          radio.value = c.id;
          radio.style.marginTop = "4px";

          const inner = document.createElement("div");

          const nameEl = document.createElement("p");
          nameEl.style.margin = "0 0 2px";
          nameEl.style.fontWeight = "700";
          nameEl.textContent = c.userName || "ржирж╛ржо ржирзЗржЗ";

          const symEl = document.createElement("p");
          symEl.style.margin = "0 0 2px";
          symEl.style.fontSize = "13px";
          symEl.style.color = "#4b5563";
          symEl.textContent = "ржирж┐рж░рзНржмрж╛ржЪржирзА ржкрзНрж░рждрзАржХ: " + (c.symbol || "ржЙрж▓рзНрж▓рзЗржЦ ржирзЗржЗ");

          const manEl = document.createElement("p");
          manEl.style.margin = "0";
          manEl.style.fontSize = "13px";
          manEl.style.color = "#6b7280";
          manEl.textContent = c.manifesto || "ржХрзЛржирзЛ ржЗрж╢рждрзЗрж╣рж╛рж░ ржжрзЗржУрзЯрж╛ рж╣рзЯржирж┐ред";

          inner.appendChild(nameEl);
          inner.appendChild(symEl);
          inner.appendChild(manEl);

          wrapper.appendChild(radio);
          wrapper.appendChild(inner);
          candListEl.appendChild(wrapper);
        });
      }

      function updateFormAvailability() {
        if (!submitBtn) return;

        if (!electionRow) {
          submitBtn.disabled = true;
          return;
        }

        if (electionRow.status !== "active") {
          submitBtn.disabled = true;
          voteMessageEl.style.color = "#b91c1c";
          voteMessageEl.textContent = "ржПржЗ ржирж┐рж░рзНржмрж╛ржЪржи ржмрж░рзНрждржорж╛ржирзЗ рж╕ржХрзНрж░рж┐рзЯ ржирзЯ, рждрж╛ржЗ ржнрзЛржЯ ржжрзЗржУрзЯрж╛ ржпрж╛ржмрзЗ ржирж╛ред";
          return;
        }

        if (existingVote) {
          submitBtn.disabled = true;
          voteMessageEl.style.color = "#15803d";
          voteMessageEl.textContent = "ржЖржкржирж┐ ржЗрждрж┐ржоржзрзНржпрзЗ ржПржЗ ржирж┐рж░рзНржмрж╛ржЪржирзЗ ржнрзЛржЯ ржжрж┐рзЯрзЗржЫрзЗржиред";
          return;
        }

        if (!candidates.length) {
          submitBtn.disabled = true;
          voteMessageEl.style.color = "#4b5563";
          voteMessageEl.textContent = "ржХрзЛржирзЛ ржЕржирзБржорзЛржжрж┐ржд ржкрзНрж░рж╛рж░рзНржерзА ржирж╛ ржерж╛ржХрж╛ржпрж╝ ржнрзЛржЯ ржкрзНрж░ржжрж╛ржи рж╕ржорзНржнржм ржиржпрж╝ред";
          return;
        }

        // allowed
        submitBtn.disabled = false;
        voteMessageEl.textContent = "";
      }

      voteForm.addEventListener("submit", async (ev) => {
        ev.preventDefault();
        if (!submitBtn || submitBtn.disabled) return;

        const formData = new FormData(voteForm);
        const candidateId = formData.get("candidate");

        if (!candidateId) {
          voteMessageEl.style.color = "#b91c1c";
          voteMessageEl.textContent = "ржЕржирзБржЧрзНрж░рж╣ ржХрж░рзЗ ржПржХржЬржи ржкрзНрж░рж╛рж░рзНржерзА ржирж┐рж░рзНржмрж╛ржЪржи ржХрж░рзБржиред";
          return;
        }

        voteMessageEl.style.color = "#4b5563";
        voteMessageEl.textContent = "ржнрзЛржЯ рж╕рж╛ржмржорж┐ржЯ ржХрж░рж╛ рж╣ржЪрзНржЫрзЗ...";
        submitBtn.disabled = true;

        try {
          // double-check there is no existing vote (in case of race condition)
          const { data: existing, error: exErr } = await supabase
            .from("votes")
            .select("id")
            .eq("election_id", electionId)
            .eq("voter_id", voterRow.id)
            .maybeSingle();

          if (existing) {
            voteMessageEl.style.color = "#b91c1c";
            voteMessageEl.textContent = "ржЖржкржирж┐ ржЗрждрж┐ржоржзрзНржпрзЗ ржПржЗ ржирж┐рж░рзНржмрж╛ржЪржирзЗ ржнрзЛржЯ ржжрж┐рзЯрзЗржЫрзЗржиред";
            return;
          }

          const { error: insErr } = await supabase.from("votes").insert({
            election_id: electionId,
            candidate_id: candidateId,
            voter_id: voterRow.id
          });

          if (insErr) {
            // unique constraint violation = tried to vote twice
            if (insErr.code === "23505") {
              voteMessageEl.style.color = "#b91c1c";
              voteMessageEl.textContent = "ржЖржкржирж┐ ржЗрждрж┐ржоржзрзНржпрзЗ ржПржЗ ржирж┐рж░рзНржмрж╛ржЪржирзЗ ржнрзЛржЯ ржжрж┐рзЯрзЗржЫрзЗржиред";
              return;
            }
            throw insErr;
          }

          // local history
          const candidate = candidates.find(c => c.id === candidateId);
          saveVoteHistoryEntry({
            userId: user.id,
            electionId: electionId,
            electionTitle: electionRow.title,
            candidateId: candidateId,
            candidateName: candidate ? candidate.userName : null,
            timestamp: new Date().toISOString()
          });

          voteMessageEl.style.color = "#15803d";
          voteMessageEl.textContent = "ржнрзЛржЯ рж╕ржлрж▓ржнрж╛ржмрзЗ ржЧрзНрж░рж╣ржг ржХрж░рж╛ рж╣ржпрж╝рзЗржЫрзЗ! ржлрж▓рж╛ржлрж▓ ржкрзГрж╖рзНржарж╛ржпрж╝ ржирзЗржУржпрж╝рж╛ рж╣ржЪрзНржЫрзЗ...";

          setTimeout(() => {
            window.location.href = `voter-result.html?election_id=${encodeURIComponent(
              electionId
            )}`;
          }, 1200);
        } catch (err) {
          console.error(err);
          voteMessageEl.style.color = "#b91c1c";
          voteMessageEl.textContent = "ржнрзЛржЯ рж╕рж╛ржмржорж┐ржЯ ржХрж░рждрзЗ рж╕ржорж╕рзНржпрж╛ рж╣ржпрж╝рзЗржЫрзЗред ржПржХржЯрзБ ржкрж░рзЗ ржЖржмрж╛рж░ ржЪрзЗрж╖рзНржЯрж╛ ржХрж░рзБржиред";
          submitBtn.disabled = false;
        }
      });

      loadAll();
    })();
  </script>
</body>
</html>
