<!DOCTYPE html>
<html lang="bn">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CampusCast - ‡¶™‡ßç‡¶∞‡¶æ‡¶∞‡ßç‡¶•‡ßÄ ‡¶°‡ßç‡¶Ø‡¶æ‡¶∂‡¶¨‡ßã‡¶∞‡ßç‡¶°</title>
  <link rel="stylesheet" href="../assets/style.css" />
</head>
<body>
  <div class="hands-bg"></div>

  <div class="container">
    <!-- Header like login/reg -->
    <header class="site-header">
      <a href="../index.html" class="logo" aria-label="CampusCast ‡¶π‡ßã‡¶Æ‡¶™‡ßá‡¶ú‡ßá ‡¶Ø‡¶æ‡¶®">
        <div class="logo-text">
          <span>CampusCast</span>
          <div class="logo-bars">
            <div class="bar"></div>
            <div class="bar alt"></div>
            <div class="bar"></div>
            <div class="bar alt"></div>
          </div>
        </div>
        <div class="logo-subtitle">‡¶¨‡¶ø‡¶∂‡ßç‡¶¨‡¶¨‡¶ø‡¶¶‡ßç‡¶Ø‡¶æ‡¶≤‡ßü ‡¶á ‡¶≠‡ßã‡¶ü‡¶ø‡¶Ç ‡¶∏‡¶ø‡¶∏‡ßç‡¶ü‡ßá‡¶Æ</div>
      </a>

      <nav class="site-nav">
        <a href="../index.html" class="nav-link">‡¶π‡ßã‡¶Æ</a>
        <a id="logoutBtn" class="login-btn" role="button">‡¶≤‡¶ó‡¶Ü‡¶â‡¶ü</a>
      </nav>
    </header>

    <main class="main-content" style="gap:40px; align-items:flex-start;">
      <!-- Left text column -->
      <section class="content" style="max-width:460px;">
        <span class="badge">‡¶™‡ßç‡¶∞‡¶æ‡¶∞‡ßç‡¶•‡ßÄ ‡¶™‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤</span>
        <h1>‡¶∏‡ßç‡¶¨‡¶æ‡¶ó‡¶§‡¶Æ ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶™‡ßç‡¶∞‡¶æ‡¶∞‡ßç‡¶•‡ßÄ ‡¶°‡ßç‡¶Ø‡¶æ‡¶∂‡¶¨‡ßã‡¶∞‡ßç‡¶°‡ßá</h1>
        <p class="description" id="candidateGreeting">
          ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶§‡¶•‡ßç‡¶Ø ‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...
        </p>

        <div class="ethereum-note" style="margin-top:12px;">
          <span class="ethereum-icon">üîê</span>
          ‡¶ï‡ßá‡¶¨‡¶≤ ‡¶≤‡¶ó‡¶á‡¶®‡¶ï‡ßÉ‡¶§ ‡¶™‡ßç‡¶∞‡¶æ‡¶∞‡ßç‡¶•‡ßÄ‡¶∞ ‡¶§‡¶•‡ßç‡¶Ø‡¶á ‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶¶‡ßá‡¶ñ‡¶æ ‡¶Ø‡¶æ‡¶¨‡ßá‡•§
        </div>
      </section>

      <!-- Right cards column -->
      <section aria-label="‡¶™‡ßç‡¶∞‡¶æ‡¶∞‡ßç‡¶•‡ßÄ ‡¶§‡¶•‡ßç‡¶Ø" style="flex:1; max-width:540px;">
        <div style="
          background:#fff;
          border:1px solid var(--border);
          border-radius:14px;
          box-shadow:0 6px 18px rgba(0,0,0,.08);
          padding:22px;
          margin-bottom:18px;
        ">
          <h2 style="margin-bottom:10px; font-size:22px; font-weight:800; color:var(--ink);">
            ‡¶™‡ßç‡¶∞‡¶´‡¶æ‡¶á‡¶≤ ‡¶ì ‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶Ö‡¶¨‡¶∏‡ßç‡¶•‡¶æ
          </h2>

          <div id="candidateMeta" style="margin-bottom:10px; font-size:14px; line-height:1.6;">
            <!-- Filled by JS -->
          </div>
        </div>

        <!-- Application card -->
        <div style="
          background:#fff;
          border:1px solid var(--border);
          border-radius:14px;
          box-shadow:0 6px 18px rgba(0,0,0,.08);
          padding:22px;
        ">
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
            <h2 style="margin:0; font-size:20px; font-weight:800; color:var(--ink);">
              ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶®‡ßá ‡¶Ö‡¶Ç‡¶∂‡¶ó‡ßç‡¶∞‡¶π‡¶£‡ßá‡¶∞ ‡¶Ü‡¶¨‡ßá‡¶¶‡¶®
            </h2>
            <span id="statusPill"
                  style="font-size:12px; padding:4px 10px; border-radius:999px; font-weight:600; background:#f3f4f6; color:#4b5563;">
              ‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...
            </span>
          </div>

          <form id="applicationForm" autocomplete="off" novalidate>
            <!-- Election select -->
            <div class="form-group" style="margin-bottom:10px;">
              <label for="electionSelect" style="display:block; font-weight:700; margin-bottom:6px;">
                ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®
              </label>
              <select
                id="electionSelect"
                required
                style="width:100%; padding:10px; border:1px solid var(--border); border-radius:10px; font-size:14px;"
              >
                <option value="">‡¶â‡¶™‡¶≤‡¶≠‡ßç‡¶Ø ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</option>
              </select>
              <small id="electionHelp" style="display:block; margin-top:4px; font-size:12px; color:#6b7280;">
                ‡¶ï‡ßá‡¶¨‡¶≤ ‡¶∏‡¶ï‡ßç‡¶∞‡¶ø‡¶Ø‡¶º ‡¶¨‡¶æ ‡¶®‡¶ø‡¶∞‡ßç‡¶ß‡¶æ‡¶∞‡¶ø‡¶§ ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶®‡ßá ‡¶Ü‡¶¨‡ßá‡¶¶‡¶® ‡¶ï‡¶∞‡¶æ ‡¶Ø‡¶æ‡¶¨‡ßá‡•§
              </small>
            </div>

            <!-- Symbol input -->
            <div class="form-group" style="margin-bottom:10px;">
              <label for="symbolInput" style="display:block; font-weight:700; margin-bottom:6px;">
                ‡¶™‡ßç‡¶∞‡¶§‡ßÄ‡¶ï / ‡¶ö‡¶ø‡¶π‡ßç‡¶®
              </label>
              <input
                type="text"
                id="symbolInput"
                name="symbol"
                placeholder="‡¶â‡¶¶‡¶æ‡¶π‡¶∞‡¶£: ‡¶¨‡¶á, ‡¶≤‡ßç‡¶Ø‡¶æ‡¶™‡¶ü‡¶™, ‡¶ï‡¶≤‡¶Æ ‡¶á‡¶§‡ßç‡¶Ø‡¶æ‡¶¶‡¶ø"
                style="width:100%; padding:10px; border:1px solid var(--border); border-radius:10px; font-size:14px;"
              />
              <small style="display:block; margin-top:4px; font-size:12px; color:#6b7280;">
                ‡¶Ü‡¶™‡¶®‡¶ø ‡¶Ø‡ßá ‡¶™‡ßç‡¶∞‡¶§‡ßÄ‡¶ï‡ßá ‡¶¶‡¶æ‡¶Å‡ßú‡¶æ‡¶§‡ßá ‡¶ö‡¶æ‡¶®, ‡¶§‡¶æ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®‡•§ ‡¶ö‡ßÇ‡ßú‡¶æ‡¶®‡ßç‡¶§ ‡¶™‡ßç‡¶∞‡¶§‡ßÄ‡¶ï ‡¶∏‡ßÅ‡¶™‡¶æ‡¶∞‡¶≠‡¶æ‡¶á‡¶ú‡¶æ‡¶∞ ‡¶Ö‡¶®‡ßÅ‡¶Æ‡ßã‡¶¶‡¶® ‡¶ï‡¶∞‡¶¨‡ßá‡¶®‡•§
              </small>
            </div>

            <!-- Manifesto -->
            <div class="form-group" style="margin-bottom:10px;">
              <label for="manifestoInput" style="display:block; font-weight:700; margin-bottom:6px;">
                ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶á‡¶∂‡¶§‡ßá‡¶π‡¶æ‡¶∞
              </label>
              <textarea
                id="manifestoInput"
                rows="4"
                placeholder="‡¶∏‡¶Ç‡¶ï‡ßç‡¶∑‡ßá‡¶™‡ßá ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶® ‡¶ï‡ßá‡¶® ‡¶Ü‡¶™‡¶®‡¶ø ‡¶™‡ßç‡¶∞‡¶æ‡¶∞‡ßç‡¶•‡ßÄ ‡¶π‡¶§‡ßá ‡¶ö‡¶æ‡¶® ‡¶è‡¶¨‡¶Ç ‡¶ï‡ßÄ ‡¶ï‡ßÄ ‡¶ï‡¶æ‡¶ú ‡¶ï‡¶∞‡¶¨‡ßá‡¶®..."
                style="width:100%; padding:10px; border:1px solid var(--border); border-radius:10px; font-size:14px; resize:vertical;"
              ></textarea>
            </div>

            <p id="formStatus" style="margin:.5rem 0 .25rem; font-size:14px;"></p>

            <button type="submit" class="btn btn-primary" style="width:100%; margin-top:4px;">
              ‡¶Ü‡¶¨‡ßá‡¶¶‡¶® ‡¶∏‡¶æ‡¶¨‡¶Æ‡¶ø‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®
            </button>
          </form>
        </div>
      </section>
    </main>

    <footer class="features">
      <div class="feature">
        <div class="feature-icon">üßæ</div>
        <div class="feature-text">
          <h3>‡¶∏‡ßç‡¶¨‡¶ö‡ßç‡¶õ ‡¶™‡ßç‡¶∞‡¶ï‡ßç‡¶∞‡¶ø‡ßü‡¶æ</h3>
          <p>‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶™‡ßç‡¶∞‡¶æ‡¶∞‡ßç‡¶•‡¶ø‡¶§‡¶æ ‡¶ì ‡¶≠‡ßã‡¶ü ‡¶™‡ßç‡¶∞‡¶ï‡ßç‡¶∞‡¶ø‡ßü‡¶æ ‡¶∞‡¶ø‡ßü‡ßá‡¶≤ ‡¶ü‡¶æ‡¶á‡¶Æ‡ßá ‡¶ü‡ßç‡¶∞‡ßç‡¶Ø‡¶æ‡¶ï‡¶Ø‡ßã‡¶ó‡ßç‡¶Ø‡•§</p>
        </div>
      </div>
      <div class="feature">
        <div class="feature-icon">üîí</div>
        <div class="feature-text">
          <h3>‡¶®‡¶ø‡¶∞‡¶æ‡¶™‡¶¶ ‡¶°‡ßá‡¶ü‡¶æ</h3>
          <p>‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶¨‡ßç‡¶Ø‡¶ï‡ßç‡¶§‡¶ø‡¶ó‡¶§ ‡¶§‡¶•‡ßç‡¶Ø ‡¶∏‡ßÅ‡¶∞‡¶ï‡ßç‡¶∑‡¶ø‡¶§ ‡¶∞‡¶æ‡¶ñ‡¶æ ‡¶π‡ßü‡•§</p>
        </div>
      </div>
      <div class="feature">
        <div class="feature-icon">‚ö°</div>
        <div class="feature-text">
          <h3>‡¶¶‡ßç‡¶∞‡ßÅ‡¶§ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü</h3>
          <p>‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶®‡ßá‡¶∞ ‡¶Ö‡¶¨‡¶∏‡ßç‡¶•‡¶æ ‡¶ì ‡¶´‡¶≤‡¶æ‡¶´‡¶≤ ‡¶¶‡ßç‡¶∞‡ßÅ‡¶§ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶π‡ßü‡•§</p>
        </div>
      </div>

      <div class="footer-credit">
        <p>¬© ‡ß®‡ß¶‡ß®‡ß´ <strong>FourA</strong> - CampusCast</p>
      </div>
    </footer>
  </div>

  <!-- Supabase client -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>

  <script>
    /**
     * Supabase configuration and localStorage keys.
     * These must match your login page.
     * @type {string}
     */
    const SUPABASE_URL = "https://hgxjuxgxgbjjqxxvafhx.supabase.co";
    const SUPABASE_ANON_KEY = "sb_publishable_RqoNSHsQQOhs8dfL0OXsdA_TfeVyZcn";
    const CC_CURRENT_USER_KEY = "cc_currentUser";

    /**
     * Supabase client instance.
     * @type {import('https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js').SupabaseClient}
     */
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    /**
     * Current logged in user shape stored by login page.
     * @typedef {Object} CurrentUser
     * @property {string} id
     * @property {string} email
     * @property {string} name
     * @property {"candidate"|"voter"|"public"|"supervisor"} role
     */

    /**
     * Candidate row with joined election.
     * @typedef {Object} CandidateWithElection
     * @property {string} id
     * @property {string} user_id
     * @property {string|null} election_id
     * @property {string|null} manifesto
     * @property {string|null} symbol
     * @property {string|null} requested_symbol
     * @property {string|null} approved_symbol
     * @property {boolean} is_approved
     * @property {"draft"|"submitted"|"under_review"|"approved"|"rejected"} status
     * @property {string} created_at
     * @property {string|null} submitted_at
     * @property {string|null} approved_at
     * @property {Object|null} election
     * @property {string} [election.id]
     * @property {string} [election.title]
     * @property {string|null} [election.description]
     * @property {"draft"|"scheduled"|"active"|"closed"} [election.status]
     * @property {string|null} [election.start_at]
     * @property {string|null} [election.end_at]
     */

    /**
     * Election row used for dropdown.
     * @typedef {Object} ElectionSummary
     * @property {string} id
     * @property {string} title
     * @property {"draft"|"scheduled"|"active"|"closed"} status
     * @property {string|null} start_at
     * @property {string|null} end_at
     */

    /**
     * Ensure there is a logged in user with role candidate.
     * If not, redirect to login or home.
     * @returns {CurrentUser}
     */
    function requireCurrentUser() {
      const raw = localStorage.getItem(CC_CURRENT_USER_KEY);
      if (!raw) {
        alert("‡¶™‡ßç‡¶∞‡¶•‡¶Æ‡ßá ‡¶≤‡¶ó‡¶á‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®‡•§");
        window.location.href = "../login/login.html";
        throw new Error("No logged in user");
      }

      /** @type {CurrentUser} */
      const user = JSON.parse(raw);

      if (user.role !== "candidate") {
        alert("‡¶∂‡ßÅ‡¶ß‡ßÅ ‡¶™‡ßç‡¶∞‡¶æ‡¶∞‡ßç‡¶•‡ßÄ‡¶∞‡¶æ‡¶á ‡¶è‡¶á ‡¶™‡ßá‡¶á‡¶ú ‡¶¶‡ßá‡¶ñ‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡¶¨‡ßá‡•§");
        window.location.href = "../index.html";
        throw new Error("User is not candidate");
      }

      return user;
    }

    /**
     * Fetch candidate record plus joined election by user id.
     * @param {string} userId
     * @returns {Promise<CandidateWithElection|null>}
     */
    async function fetchCandidateForUser(userId) {
      const { data, error } = await supabase
        .from("candidates")
        .select(`
          id,
          user_id,
          election_id,
          manifesto,
          symbol,
          requested_symbol,
          approved_symbol,
          is_approved,
          status,
          created_at,
          submitted_at,
          approved_at,
          election:election_id (
            id,
            title,
            description,
            status,
            start_at,
            end_at
          )
        `)
        .eq("user_id", userId)
        .maybeSingle();

      if (error) {
        console.error("Error fetching candidate:", error);
        throw new Error("‡¶™‡ßç‡¶∞‡¶æ‡¶∞‡ßç‡¶•‡ßÄ‡¶∞ ‡¶§‡¶•‡ßç‡¶Ø ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø‡•§");
      }

      return data;
    }

    /**
     * Fetch list of elections candidate can apply to.
     * Simple rule: status in scheduled or active.
     * @returns {Promise<ElectionSummary[]>}
     */
    async function fetchAvailableElections() {
      const { data, error } = await supabase
        .from("elections")
        .select("id, title, status, start_at, end_at")
        .in("status", ["scheduled", "active"])
        .order("start_at", { ascending: true });

      if (error) {
        console.error("Error fetching elections:", error);
        throw new Error("‡¶â‡¶™‡¶≤‡¶≠‡ßç‡¶Ø ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø‡•§");
      }

      return data || [];
    }

    /**
     * Map candidate status to human readable text in Bangla.
     * @param {"draft"|"submitted"|"under_review"|"approved"|"rejected"|null} status
     * @returns {string}
     */
    function statusText(status) {
      switch (status) {
        case "submitted":
          return "‡¶∏‡¶æ‡¶¨‡¶Æ‡¶ø‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá";
        case "under_review":
          return "‡¶™‡¶∞‡ßç‡¶Ø‡¶æ‡¶≤‡ßã‡¶ö‡¶®‡¶æ‡¶ß‡ßÄ‡¶®";
        case "approved":
          return "‡¶Ö‡¶®‡ßÅ‡¶Æ‡ßã‡¶¶‡¶ø‡¶§";
        case "rejected":
          return "‡¶¨‡¶æ‡¶§‡¶ø‡¶≤";
        default:
          return "‡¶°‡ßç‡¶∞‡¶æ‡¶´‡¶ü";
      }
    }

    /**
     * Return badge colors for candidate status pill.
     * @param {"draft"|"submitted"|"under_review"|"approved"|"rejected"|null} status
     * @returns {{bg: string, color: string}}
     */
    function statusColors(status) {
      switch (status) {
        case "submitted":
        case "under_review":
          return { bg: "#fef3c7", color: "#92400e" };
        case "approved":
          return { bg: "#dcfce7", color: "#166534" };
        case "rejected":
          return { bg: "#fee2e2", color: "#b91c1c" };
        default:
          return { bg: "#e5e7eb", color: "#4b5563" };
      }
    }

    /**
     * Render profile block and status.
     * @param {CurrentUser} user
     * @param {CandidateWithElection|null} candidate
     * @returns {void}
     */
    function renderCandidateProfile(user, candidate) {
      const greetEl = document.getElementById("candidateGreeting");
      const metaEl = document.getElementById("candidateMeta");
      const statusPill = document.getElementById("statusPill");

      if (!greetEl || !metaEl || !statusPill) return;

      greetEl.textContent = `${user.name || user.email} ‡¶™‡ßç‡¶∞‡¶æ‡¶∞‡ßç‡¶•‡ßÄ ‡¶π‡¶ø‡¶∏‡¶æ‡¶¨‡ßá ‡¶≤‡¶ó‡¶á‡¶® ‡¶ï‡¶∞‡ßá‡¶õ‡ßá‡¶®‡•§`;

      if (!candidate) {
        metaEl.innerHTML = `
          <p style="margin:0 0 6px;">
            ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶ï‡ßã‡¶®‡ßã ‡¶™‡ßç‡¶∞‡¶æ‡¶∞‡ßç‡¶•‡ßÄ ‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶° ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø‡•§
          </p>
          <p style="margin:0;">
            ‡¶®‡¶ø‡¶¨‡¶®‡ßç‡¶ß‡¶®‡ßá‡¶∞ ‡¶∏‡¶Æ‡ßü ‡¶Ü‡¶™‡¶®‡¶ø candidate ‡¶∞‡ßã‡¶≤ ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßá‡¶õ‡ßá‡¶® ‡¶ï‡¶ø‡¶®‡¶æ ‡¶§‡¶æ ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§ ‡¶ï‡¶∞‡ßÅ‡¶®,
            ‡¶Ö‡¶•‡¶¨‡¶æ ‡¶∏‡ßÅ‡¶™‡¶æ‡¶∞‡¶≠‡¶æ‡¶á‡¶ú‡¶æ‡¶∞‡ßá‡¶∞ ‡¶∏‡¶æ‡¶•‡ßá ‡¶Ø‡ßã‡¶ó‡¶æ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®‡•§
          </p>
        `;
        const colors = statusColors(null);
        statusPill.textContent = statusText(null);
        statusPill.style.backgroundColor = colors.bg;
        statusPill.style.color = colors.color;
        return;
      }

      const createdDate = candidate.created_at
        ? new Date(candidate.created_at).toLocaleString()
        : "N/A";

      metaEl.innerHTML = `
        <p style="margin:0 0 6px;"><strong>‡¶®‡¶æ‡¶Æ:</strong> ${user.name || "N/A"}</p>
        <p style="margin:0 0 6px;"><strong>‡¶á‡¶Æ‡ßá‡¶á‡¶≤:</strong> ${user.email}</p>
        <p style="margin:0 0 6px;">
          <strong>‡¶™‡ßç‡¶∞‡¶æ‡¶∞‡ßç‡¶•‡ßÄ ‡¶π‡¶ø‡¶∏‡¶æ‡¶¨‡ßá ‡¶∞‡ßá‡¶ú‡¶ø‡¶∏‡ßç‡¶ü‡ßç‡¶∞‡ßá‡¶∂‡¶®:</strong> ${createdDate}
        </p>
        <p style="margin:0 0 6px;">
          <strong>‡¶Ö‡¶®‡ßÅ‡¶Æ‡ßã‡¶¶‡¶® ‡¶Ö‡¶¨‡¶∏‡ßç‡¶•‡¶æ:</strong>
          <span style="font-weight:600; color:${candidate.is_approved ? "#16a34a" : "#eab308"};">
            ${candidate.is_approved ? "‡¶Ö‡¶®‡ßÅ‡¶Æ‡ßã‡¶¶‡¶ø‡¶§" : "‡¶∞‡¶ø‡¶≠‡¶ø‡¶â‡¶§‡ßá ‡¶Ü‡¶õ‡ßá"}
          </span>
        </p>
      `;

      if (candidate.manifesto) {
        metaEl.insertAdjacentHTML(
          "beforeend",
          `
          <div style="margin-top:10px;">
            <strong>‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶á‡¶∂‡¶§‡ßá‡¶π‡¶æ‡¶∞:</strong>
            <p style="margin:4px 0 0;">${candidate.manifesto}</p>
          </div>
        `
        );
      }

      const colors = statusColors(candidate.status);
      statusPill.textContent = statusText(candidate.status);
      statusPill.style.backgroundColor = colors.bg;
      statusPill.style.color = colors.color;
    }

    /**
     * Populate election dropdown with available elections
     * and select current assigned one if exists.
     * @param {HTMLSelectElement} selectEl
     * @param {ElectionSummary[]} elections
     * @param {CandidateWithElection|null} candidate
     * @returns {void}
     */
    function renderElectionOptions(selectEl, elections, candidate) {
      selectEl.innerHTML = "";

      if (!elections.length) {
        const opt = document.createElement("option");
        opt.value = "";
        opt.textContent = "‡¶ï‡ßã‡¶®‡ßã ‡¶â‡¶™‡¶≤‡¶≠‡ßç‡¶Ø ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶®‡ßá‡¶á";
        selectEl.appendChild(opt);
        selectEl.disabled = true;
        return;
      }

      const placeholder = document.createElement("option");
      placeholder.value = "";
      placeholder.textContent = "‡¶è‡¶ï‡¶ü‡¶ø ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®";
      selectEl.appendChild(placeholder);

      elections.forEach((election) => {
        const opt = document.createElement("option");
        opt.value = election.id;
        const labelStatus = election.status === "scheduled" ? "‡¶®‡¶ø‡¶∞‡ßç‡¶ß‡¶æ‡¶∞‡¶ø‡¶§" : "‡¶ö‡¶≤‡¶Æ‡¶æ‡¶®";
        opt.textContent = `${election.title} (${labelStatus})`;
        selectEl.appendChild(opt);
      });

      if (candidate && candidate.election_id) {
        selectEl.value = candidate.election_id;
      }
    }

    /**
     * Fill the form fields (symbol and manifesto) with existing candidate data.
     * @param {CandidateWithElection|null} candidate
     * @returns {void}
     */
    function fillFormFromCandidate(candidate) {
      const symbolInput = /** @type {HTMLInputElement} */ (document.getElementById("symbolInput"));
      const manifestoInput = /** @type {HTMLTextAreaElement} */ (document.getElementById("manifestoInput"));

      if (!symbolInput || !manifestoInput) return;

      if (!candidate) {
        symbolInput.value = "";
        manifestoInput.value = "";
        return;
      }

      symbolInput.value = candidate.requested_symbol || candidate.symbol || "";
      manifestoInput.value = candidate.manifesto || "";
    }

    /**
     * Submit application update to Supabase.
     * Sets election_id, requested_symbol, manifesto, status, submitted_at.
     * @param {string} candidateId
     * @param {string} electionId
     * @param {string} requestedSymbol
     * @param {string} manifesto
     * @returns {Promise<void>}
     */
    async function submitApplication(candidateId, electionId, requestedSymbol, manifesto) {
      const payload = {
        election_id: electionId,
        requested_symbol: requestedSymbol || null,
        manifesto: manifesto || null,
        status: "submitted",
        submitted_at: new Date().toISOString()
      };

      const { error } = await supabase
        .from("candidates")
        .update(payload)
        .eq("id", candidateId);

      if (error) {
        console.error("Error updating candidate:", error);
        throw new Error("‡¶Ü‡¶¨‡ßá‡¶¶‡¶® ‡¶∏‡¶æ‡¶¨‡¶Æ‡¶ø‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø‡•§");
      }
    }

    /**
     * Logout the current user.
     * @returns {void}
     */
    function logout() {
      localStorage.removeItem(CC_CURRENT_USER_KEY);
      window.location.href = "../login/login.html";
    }

    /**
     * Initialize candidate dashboard.
     * Loads data, renders UI, binds form submit.
     * @returns {Promise<void>}
     */
    async function initDashboard() {
      const user = requireCurrentUser();

      const logoutBtn = document.getElementById("logoutBtn");
      if (logoutBtn) {
        logoutBtn.addEventListener("click", logout);
      }

      const form = /** @type {HTMLFormElement} */ (document.getElementById("applicationForm"));
      const electionSelect = /** @type {HTMLSelectElement} */ (document.getElementById("electionSelect"));
      const symbolInput = /** @type {HTMLInputElement} */ (document.getElementById("symbolInput"));
      const manifestoInput = /** @type {HTMLTextAreaElement} */ (document.getElementById("manifestoInput"));
      const formStatus = /** @type {HTMLParagraphElement} */ (document.getElementById("formStatus"));

      if (!form || !electionSelect || !symbolInput || !manifestoInput || !formStatus) {
        console.warn("Form elements not found");
        return;
      }

      try {
        const [candidate, elections] = await Promise.all([
          fetchCandidateForUser(user.id),
          fetchAvailableElections()
        ]);

        renderCandidateProfile(user, candidate);
        renderElectionOptions(electionSelect, elections, candidate);
        fillFormFromCandidate(candidate);

        form.addEventListener("submit", async function (event) {
          event.preventDefault();
          formStatus.textContent = "";
          formStatus.style.color = "crimson";

          const electionId = electionSelect.value;
          const requestedSymbol = symbolInput.value.trim();
          const manifesto = manifestoInput.value.trim();

          if (!candidate || !candidate.id) {
            formStatus.textContent = "‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶™‡ßç‡¶∞‡¶æ‡¶∞‡ßç‡¶•‡ßÄ ‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤ ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø‡•§";
            return;
          }
          if (!electionId) {
            formStatus.textContent = "‡¶è‡¶ï‡¶ü‡¶ø ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®‡•§";
            return;
          }

          try {
            await submitApplication(candidate.id, electionId, requestedSymbol, manifesto);
            formStatus.style.color = "green";
            formStatus.textContent = "‡¶Ü‡¶¨‡ßá‡¶¶‡¶® ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶∏‡¶æ‡¶¨‡¶Æ‡¶ø‡¶ü ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§";

            // refresh candidate info to update status display
            const updatedCandidate = await fetchCandidateForUser(user.id);
            renderCandidateProfile(user, updatedCandidate);
          } catch (err) {
            formStatus.textContent =
              err && err.message ? err.message : "‡¶Ü‡¶¨‡ßá‡¶¶‡¶® ‡¶∏‡¶æ‡¶¨‡¶Æ‡¶ø‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§";
          }
        });
      } catch (err) {
        console.error(err);
        const greetEl = document.getElementById("candidateGreeting");
        if (greetEl) {
          greetEl.textContent = "‡¶∏‡¶æ‡¶∞‡ßç‡¶≠‡¶æ‡¶∞ ‡¶•‡ßá‡¶ï‡ßá ‡¶§‡¶•‡ßç‡¶Ø ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø‡•§";
        }
        if (formStatus) {
          formStatus.textContent = "‡¶°‡ßç‡¶Ø‡¶æ‡¶∂‡¶¨‡ßã‡¶∞‡ßç‡¶° ‡¶°‡ßá‡¶ü‡¶æ ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§";
          formStatus.style.color = "crimson";
        }
      }
    }

    // Run once on page load
    initDashboard();
  </script>
</body>
</html>
