<!DOCTYPE html>
<html lang="bn">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>‡¶®‡¶ø‡¶¨‡¶®‡ßç‡¶ß‡¶ø‡¶§ ‡¶≠‡ßã‡¶ü‡¶æ‡¶∞ - Supervisor | CampusCast</title>
  <link rel="stylesheet" href="../assets/style.css" />
</head>
<body>
  <div class="hands-bg"></div>

  <div class="container">
    <!-- Header -->
    <header class="site-header">
      <a href="../index.html" class="logo" aria-label="CampusCast ‡¶π‡ßã‡¶Æ‡¶™‡ßá‡¶ú‡ßá ‡¶Ø‡¶æ‡¶®">
        <div class="logo-text">
          <span>CampusCast</span>
          <div class="logo-bars">
            <div class="bar"></div>
            <div class="bar alt"></div>
            <div class="bar"></div>
            <div class="bar alt"></div>
          </div>
        </div>
        <div class="logo-subtitle">‡¶¨‡¶ø‡¶∂‡ßç‡¶¨‡¶¨‡¶ø‡¶¶‡ßç‡¶Ø‡¶æ‡¶≤‡ßü ‡¶á ‡¶≠‡ßã‡¶ü‡¶ø‡¶Ç ‡¶∏‡¶ø‡¶∏‡ßç‡¶ü‡ßá‡¶Æ</div>
      </a>

      <nav class="site-nav">
        <a href="supervisor.html" class="nav-link">‡¶°‡ßç‡¶Ø‡¶æ‡¶∂‡¶¨‡ßã‡¶∞‡ßç‡¶°</a>
        <a href="totalelection.html" class="nav-link">‡¶Æ‡ßã‡¶ü ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶®</a>
        <a href="supervisedpoll.html" class="nav-link">‡¶§‡¶§‡ßç‡¶§‡ßç‡¶¨‡¶æ‡¶¨‡¶ß‡¶æ‡ßü‡¶ï ‡¶™‡ßã‡¶≤</a>
        <a href="registervoters.html" class="nav-link">‡¶®‡¶ø‡¶¨‡¶®‡ßç‡¶ß‡¶ø‡¶§ ‡¶≠‡ßã‡¶ü‡¶æ‡¶∞</a>
        <a href="registeredcandidates.html" class="nav-link">‡¶®‡¶ø‡¶¨‡¶®‡ßç‡¶ß‡¶ø‡¶§ ‡¶™‡ßç‡¶∞‡¶æ‡¶∞‡ßç‡¶•‡ßÄ</a>
        <button class="login-btn" type="button" onclick="logout()">‡¶≤‡¶ó‡¶Ü‡¶â‡¶ü</button>
      </nav>
    </header>

    <main class="main-content supervisor-main" style="flex-direction:column; gap:24px;">
      <section class="content" style="max-width:900px;">
        <span class="badge">‡¶∏‡ßÅ‡¶™‡¶æ‡¶∞‡¶≠‡¶æ‡¶á‡¶ú‡¶æ‡¶∞ ‡¶™‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤</span>
        <h1>‡¶®‡¶ø‡¶¨‡¶®‡ßç‡¶ß‡¶ø‡¶§ ‡¶≠‡ßã‡¶ü‡¶æ‡¶∞‡ßá‡¶∞ ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ</h1>
        <p class="description">
          ‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶∏‡¶ï‡¶≤ ‡¶®‡¶ø‡¶¨‡¶®‡ßç‡¶ß‡¶ø‡¶§ ‡¶≠‡ßã‡¶ü‡¶æ‡¶∞ ‡¶¶‡ßá‡¶ñ‡¶æ ‡¶Ø‡¶æ‡¶¨‡ßá‡•§ ‡¶è‡¶ñ‡¶æ‡¶® ‡¶•‡ßá‡¶ï‡ßá ‡¶Ü‡¶™‡¶®‡¶ø ‡¶§‡¶æ‡¶¶‡ßá‡¶∞ ‡¶Ö‡¶®‡ßÅ‡¶Æ‡ßã‡¶¶‡¶®, ‡¶¨‡ßç‡¶Ø‡¶æ‡¶® ‡¶¨‡¶æ ‡¶∏‡¶Æ‡ßç‡¶™‡ßÇ‡¶∞‡ßç‡¶£‡¶≠‡¶æ‡¶¨‡ßá ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡¶¨‡ßá‡¶®,
          ‡¶è‡¶¨‡¶Ç ‡¶ï‡ßã‡¶® ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶®‡ßá‡¶∞ ‡¶≠‡ßã‡¶ü‡¶æ‡¶∞ ‡¶π‡¶¨‡ßá ‡¶§‡¶æ ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶ø‡¶§ ‡¶ï‡¶∞‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡¶¨‡ßá‡¶®‡•§
        </p>
        <p id="voterStatus" style="font-size:14px; margin-top:6px;"></p>
      </section>

      <section style="width:100%; max-width:900px;">
        <div style="
          background:#fff;
          border:1px solid var(--border);
          border-radius:14px;
          box-shadow:0 6px 18px rgba(0,0,0,.08);
          padding:16px;
          overflow-x:auto;
        ">
          <table style="width:100%; border-collapse:collapse; font-size:14px;">
            <thead>
              <tr style="text-align:left; border-bottom:1px solid var(--border);">
                <th style="padding:8px;">‡¶®‡¶æ‡¶Æ</th>
                <th style="padding:8px;">‡¶á‡¶Æ‡ßá‡¶á‡¶≤</th>
                <th style="padding:8px;">‡¶∏‡ßç‡¶ü‡ßÅ‡¶°‡ßá‡¶®‡ßç‡¶ü ‡¶Ü‡¶á‡¶°‡¶ø</th>
                <th style="padding:8px;">‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶®</th>
                <th style="padding:8px; text-align:center;">‡¶Ö‡¶®‡ßÅ‡¶Æ‡ßã‡¶¶‡¶ø‡¶§?</th>
                <th style="padding:8px; text-align:center;">‡¶¨‡ßç‡¶Ø‡¶æ‡¶®?</th>
                <th style="padding:8px; text-align:center;">‡¶è‡¶ï‡¶∂‡¶®</th>
              </tr>
            </thead>
            <tbody id="votersBody">
              <!-- rows will be injected here -->
            </tbody>
          </table>
        </div>
      </section>
    </main>

    <!-- Footer same as other pages -->
    <footer class="features">
      <div class="feature">
        <div class="feature-icon">üßæ</div>
        <div class="feature-text">
          <h3>‡¶∏‡ßç‡¶¨‡¶ö‡ßç‡¶õ ‡¶™‡ßç‡¶∞‡¶ï‡ßç‡¶∞‡¶ø‡ßü‡¶æ</h3>
          <p>‡¶∏‡¶Æ‡¶∏‡ßç‡¶§ ‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶° ‡¶Ø‡¶æ‡¶ö‡¶æ‡¶á‡¶Ø‡ßã‡¶ó‡ßç‡¶Ø ‡¶ì ‡¶®‡¶ø‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ‡¶Ø‡ßã‡¶ó‡ßç‡¶Ø‡•§</p>
        </div>
      </div>
      <div class="feature">
        <div class="feature-icon">üîí</div>
        <div class="feature-text">
          <h3>‡¶è‡¶®‡ßç‡¶° ‡¶ü‡ßÅ ‡¶è‡¶®‡ßç‡¶° ‡¶è‡¶®‡¶ï‡ßç‡¶∞‡¶ø‡¶™‡¶∂‡¶®</h3>
          <p>‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶ü‡¶ø ‡¶ß‡¶æ‡¶™‡ßá ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶§‡¶•‡ßç‡¶Ø ‡¶∏‡ßÅ‡¶∞‡¶ï‡ßç‡¶∑‡¶ø‡¶§ ‡¶•‡¶æ‡¶ï‡ßá‡•§</p>
        </div>
      </div>
      <div class="feature">
        <div class="feature-icon">‚ö°</div>
        <div class="feature-text">
          <h3>‡¶¶‡ßç‡¶∞‡ßÅ‡¶§ ‡¶ì ‡¶ï‡¶æ‡¶∞‡ßç‡¶Ø‡¶ï‡¶∞</h3>
          <p>‡¶∞‡¶ø‡ßü‡ßá‡¶≤ ‡¶ü‡¶æ‡¶á‡¶Æ‡ßá ‡¶´‡¶≤‡¶æ‡¶´‡¶≤ ‡¶¶‡ßá‡¶ñ‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡¶¨‡ßá‡¶®‡•§</p>
        </div>
      </div>

      <div class="nav-arrows">
        <button class="arrow-btn" aria-label="‡¶™‡ßÇ‡¶∞‡ßç‡¶¨‡ßá‡¶∞ ‡¶∏‡ßç‡¶≤‡¶æ‡¶á‡¶°">‚Äπ</button>
        <button class="arrow-btn" aria-label="‡¶™‡¶∞‡¶¨‡¶∞‡ßç‡¶§‡ßÄ ‡¶∏‡ßç‡¶≤‡¶æ‡¶á‡¶°">‚Ä∫</button>
      </div>

      <div class="dots" aria-hidden="true">
        <span class="dot active"></span>
        <span class="dot"></span>
        <span class="dot"></span>
      </div>

      <div class="footer-credit">
        <p>¬© ‡ß®‡ß¶‡ß®‡ß´ <strong>FourA</strong> | CampusCast</p>
      </div>
    </footer>
  </div>

  <!-- Supabase client -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
  <script>
    const supabaseUrl = "https://hgxjuxgxgbjjqxxvafhx.supabase.co";
    const supabaseAnonKey = "sb_publishable_RqoNSHsQQOhs8dfL0OXsdA_TfeVyZcn";
    const supabase = window.supabase.createClient(supabaseUrl, supabaseAnonKey);

    const ccCurrentUserKey = "cc_currentUser";
    let electionsCache = [];

    function getCurrentUser() {
      try {
        const raw = localStorage.getItem(ccCurrentUserKey);
        if (!raw) return null;
        return JSON.parse(raw);
      } catch (e) {
        console.error("Failed to parse current user", e);
        return null;
      }
    }

    function ensureSupervisor() {
      const user = getCurrentUser();
      if (!user || user.role !== "supervisor") {
        alert("‡¶∂‡ßÅ‡¶ß‡ßÅ‡¶Æ‡¶æ‡¶§‡ßç‡¶∞ ‡¶∏‡ßÅ‡¶™‡¶æ‡¶∞‡¶≠‡¶æ‡¶á‡¶ú‡¶æ‡¶∞ ‡¶è‡¶á ‡¶™‡ßá‡¶ú‡ßá ‡¶™‡ßç‡¶∞‡¶¨‡ßá‡¶∂ ‡¶ï‡¶∞‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡¶¨‡ßá‡¶®‡•§");
        window.location.href = "../login/login.html";
        return null;
      }
      return user;
    }

    function logout() {
      localStorage.removeItem(ccCurrentUserKey);
      window.location.href = "../index.html";
    }

    function setVoterStatus(message, isError = false) {
      const el = document.getElementById("voterStatus");
      el.style.color = isError ? "crimson" : "green";
      el.textContent = message;
    }

    function renderVoters(voters) {
      const tbody = document.getElementById("votersBody");
      if (!tbody) return;

      if (!voters || voters.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="7" style="padding:10px; text-align:center; color:#6b7280;">
              ‡¶è‡¶ñ‡¶®‡ßã ‡¶ï‡ßã‡¶®‡ßã ‡¶≠‡ßã‡¶ü‡¶æ‡¶∞ ‡¶®‡¶ø‡¶¨‡¶®‡ßç‡¶ß‡¶ø‡¶§ ‡¶®‡ßá‡¶á‡•§
            </td>
          </tr>
        `;
        return;
      }

      const rowsHtml = voters.map(voter => {
        const name = voter.user?.name || "‡¶®‡¶æ‡¶Æ ‡¶®‡ßá‡¶á";
        const email = voter.user?.email || "";
        const studentId = voter.student_id || "";
        const approvedChecked = voter.is_approved ? "checked" : "";
        const bannedChecked = voter.is_banned ? "checked" : "";
        const electionId = voter.election_id || "";

        const optionsHtml = [
          '<option value="">‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</option>',
          ...electionsCache.map(election => {
            const title = election.title || "(‡¶∂‡¶ø‡¶∞‡ßã‡¶®‡¶æ‡¶Æ ‡¶®‡ßá‡¶á)";
            const selected = election.id === electionId ? "selected" : "";
            return `<option value="${election.id}" ${selected}>${title}</option>`;
          })
        ].join("");

        return `
          <tr data-id="${voter.id}">
            <td style="padding:8px;">${name}</td>
            <td style="padding:8px;">${email}</td>
            <td style="padding:8px;">${studentId}</td>
            <td style="padding:8px; min-width:180px;">
              <select class="election-select" style="width:100%; padding:6px; border-radius:6px; border:1px solid var(--border);">
                ${optionsHtml}
              </select>
            </td>
            <td style="padding:8px; text-align:center;">
              <input type="checkbox" class="approved-checkbox" ${approvedChecked} />
            </td>
            <td style="padding:8px; text-align:center;">
              <input type="checkbox" class="banned-checkbox" ${bannedChecked} />
            </td>
            <td style="padding:8px; text-align:center;">
              <button type="button"
                      onclick="saveVoter('${voter.id}')"
                      style="padding:4px 10px; border-radius:6px; border:none; background:var(--brand); color:#fff; font-size:12px; cursor:pointer; margin-right:6px;">
                ‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶£
              </button>
              <button type="button"
                      onclick="deleteVoter('${voter.id}')"
                      style="padding:4px 10px; border-radius:6px; border:none; background:#b91c1c; color:#fff; font-size:12px; cursor:pointer;">
                ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡ßÅ‡¶®
              </button>
            </td>
          </tr>
        `;
      }).join("");

      tbody.innerHTML = rowsHtml;
    }

    async function loadVotersPage() {
      const user = ensureSupervisor();
      if (!user) return;

      setVoterStatus("‡¶≠‡ßã‡¶ü‡¶æ‡¶∞‡¶¶‡ßá‡¶∞ ‡¶§‡¶•‡ßç‡¶Ø ‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...");

      // load elections for dropdown
      const { data: elections, error: electionsError } = await supabase
        .from("elections")
        .select("id, title, status")
        .order("created_at", { ascending: false });

      if (electionsError) {
        console.error("Elections error:", electionsError);
        setVoterStatus("elections ‡¶ü‡ßá‡¶¨‡¶ø‡¶≤ ‡¶•‡ßá‡¶ï‡ßá ‡¶°‡¶æ‡¶ü‡¶æ ‡¶Ü‡¶®‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá‡•§", true);
        electionsCache = [];
      } else {
        electionsCache = elections || [];
      }

      // load voters joined with users
      const { data: voters, error: votersError } = await supabase
        .from("voters")
        .select(`
          id,
          student_id,
          is_approved,
          is_banned,
          election_id,
          user:users (
            name,
            email
          )
        `)
        .order("created_at", { ascending: false });

      if (votersError) {
        console.error("Voters error:", votersError);
        setVoterStatus("voters ‡¶ü‡ßá‡¶¨‡¶ø‡¶≤ ‡¶•‡ßá‡¶ï‡ßá ‡¶°‡¶æ‡¶ü‡¶æ ‡¶Ü‡¶®‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá‡•§", true);
        return;
      }

      renderVoters(voters);
      setVoterStatus("‡¶≠‡ßã‡¶ü‡¶æ‡¶∞‡¶¶‡ßá‡¶∞ ‡¶§‡¶•‡ßç‡¶Ø ‡¶≤‡ßã‡¶° ‡¶∏‡¶Æ‡ßç‡¶™‡¶®‡ßç‡¶® ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§", false);
    }

    async function saveVoter(id) {
      const row = document.querySelector(`tr[data-id="${id}"]`);
      if (!row) return;

      const select = row.querySelector(".election-select");
      const approvedCheckbox = row.querySelector(".approved-checkbox");
      const bannedCheckbox = row.querySelector(".banned-checkbox");

      const electionId = select.value || null;
      const approved = approvedCheckbox.checked;
      const banned = bannedCheckbox.checked;

      setVoterStatus("‡¶≠‡ßã‡¶ü‡¶æ‡¶∞‡ßá‡¶∞ ‡¶§‡¶•‡ßç‡¶Ø ‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶£ ‡¶π‡¶ö‡ßç‡¶õ‡ßá...");

      const { error } = await supabase
        .from("voters")
        .update({
          election_id: electionId,
          is_approved: approved,
          is_banned: banned
        })
        .eq("id", id);

      if (error) {
        console.error("Update voter error:", error);
        setVoterStatus("‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶£ ‡¶¨‡ßç‡¶Ø‡¶∞‡ßç‡¶• ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§ ‡¶Ü‡¶¨‡¶æ‡¶∞ ‡¶ö‡ßá‡¶∑‡ßç‡¶ü‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§", true);
        return;
      }

      setVoterStatus("‡¶≠‡ßã‡¶ü‡¶æ‡¶∞‡ßá‡¶∞ ‡¶§‡¶•‡ßç‡¶Ø ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶ø‡¶§ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§", false);
      loadVotersPage();
    }

    async function deleteVoter(id) {
      if (!confirm("‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§ ‡¶Ø‡ßá ‡¶è‡¶á ‡¶≠‡ßã‡¶ü‡¶æ‡¶∞‡¶ï‡ßá ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶§‡ßá ‡¶ö‡¶æ‡¶®?")) {
        return;
      }

      setVoterStatus("‡¶≠‡ßã‡¶ü‡¶æ‡¶∞ ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá...");

      const { error } = await supabase
        .from("voters")
        .delete()
        .eq("id", id);

      if (error) {
        console.error("Delete voter error:", error);
        setVoterStatus("‡¶≠‡ßã‡¶ü‡¶æ‡¶∞ ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶æ ‡¶¨‡ßç‡¶Ø‡¶∞‡ßç‡¶• ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§ ‡¶Ü‡¶¨‡¶æ‡¶∞ ‡¶ö‡ßá‡¶∑‡ßç‡¶ü‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§", true);
        return;
      }

      setVoterStatus("‡¶≠‡ßã‡¶ü‡¶æ‡¶∞ ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§", false);
      loadVotersPage();
    }

    window.saveVoter = saveVoter;
    window.deleteVoter = deleteVoter;

    loadVotersPage();
  </script>
</body>
</html>
