<!DOCTYPE html>
<html lang="bn">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Supervisor Dashboard | CampusCast</title>
  <link rel="stylesheet" href="../assets/style.css" />
</head>
<body>
  <div class="hands-bg"></div>

  <div class="container">
    <!-- Header same style as login/reg -->
    <header class="site-header">
      <a href="../index.html" class="logo" aria-label="CampusCast ‡¶π‡ßã‡¶Æ‡¶™‡ßá‡¶ú‡ßá ‡¶Ø‡¶æ‡¶®">
        <div class="logo-text">
          <span>CampusCast</span>
          <div class="logo-bars">
            <div class="bar"></div>
            <div class="bar alt"></div>
            <div class="bar"></div>
            <div class="bar alt"></div>
          </div>
        </div>
        <div class="logo-subtitle">‡¶¨‡¶ø‡¶∂‡ßç‡¶¨‡¶¨‡¶ø‡¶¶‡ßç‡¶Ø‡¶æ‡¶≤‡ßü ‡¶á ‡¶≠‡ßã‡¶ü‡¶ø‡¶Ç ‡¶∏‡¶ø‡¶∏‡ßç‡¶ü‡ßá‡¶Æ</div>
      </a>

<nav class="site-nav">
  <a href="../index.html" class="nav-link">‡¶π‡ßã‡¶Æ</a>
  <a href="totalelection.html" class="nav-link">‡¶Æ‡ßã‡¶ü ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶®</a>
  <a href="create_election.html" class="nav-link">‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶§‡ßà‡¶∞‡¶ø</a>
  <a href="registeredcandidates.html" class="nav-link">‡¶®‡¶ø‡¶¨‡¶®‡ßç‡¶ß‡¶ø‡¶§ ‡¶™‡ßç‡¶∞‡¶æ‡¶∞‡ßç‡¶•‡ßÄ</a>
  <a href="registervoters.html" class="nav-link">‡¶®‡¶ø‡¶¨‡¶®‡ßç‡¶ß‡¶ø‡¶§ ‡¶≠‡ßã‡¶ü‡¶æ‡¶∞</a>
  <button class="login-btn" onclick="logout()">‡¶≤‡¶ó‡¶Ü‡¶â‡¶ü</button>
</nav>


    </header>

    <main class="main-content supervisor-main">
      <!-- Intro block -->
      <section class="content" style="max-width:720px;">
        <span class="badge">‡¶∏‡ßÅ‡¶™‡¶æ‡¶∞‡¶≠‡¶æ‡¶á‡¶ú‡¶æ‡¶∞ ‡¶™‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤</span>
        <h1>‡¶∏‡ßÅ‡¶™‡¶æ‡¶∞‡¶≠‡¶æ‡¶á‡¶ú‡¶æ‡¶∞ ‡¶°‡ßç‡¶Ø‡¶æ‡¶∂‡¶¨‡ßã‡¶∞‡ßç‡¶°</h1>
        <p class="description" id="welcomeText">
          ‡¶∂‡ßÅ‡¶ß‡ßÅ‡¶Æ‡¶æ‡¶§‡ßç‡¶∞ ‡¶∏‡ßÅ‡¶™‡¶æ‡¶∞‡¶≠‡¶æ‡¶á‡¶ú‡¶æ‡¶∞ ‡¶≤‡¶ó‡¶á‡¶® ‡¶è‡¶∞ ‡¶Æ‡¶æ‡¶ß‡ßç‡¶Ø‡¶Æ‡ßá ‡¶è‡¶á ‡¶™‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤‡ßá ‡¶™‡ßç‡¶∞‡¶¨‡ßá‡¶∂ ‡¶ï‡¶∞‡¶æ ‡¶Ø‡¶æ‡¶¨‡ßá‡•§
        </p>
      </section>

      <!-- Metric cards -->
      <section aria-label="Supervisor overview">
        <div class="supervisor-grid">
          <article class="super-card">
            <h3>‡¶Æ‡ßã‡¶ü ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶®</h3>
            <p id="totalElections">0</p>
          </article>

          <article class="super-card">
            <h3>‡¶ö‡¶≤‡¶Æ‡¶æ‡¶® ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® (active)</h3>
            <p id="activeElections">0</p>
          </article>

          <article class="super-card">
            <h3>‡¶Æ‡ßã‡¶ü ‡¶®‡¶ø‡¶¨‡¶®‡ßç‡¶ß‡¶ø‡¶§ ‡¶™‡ßç‡¶∞‡¶æ‡¶∞‡ßç‡¶•‡ßÄ</h3>
            <p id="registeredCandidates">0</p>
          </article>

          <article class="super-card">
            <h3>‡¶Æ‡ßã‡¶ü ‡¶®‡¶ø‡¶¨‡¶®‡ßç‡¶ß‡¶ø‡¶§ ‡¶≠‡ßã‡¶ü‡¶æ‡¶∞</h3>
            <p id="registeredVoters">0</p>
          </article>

          <article class="super-card">
            <h3>‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶§‡¶§‡ßç‡¶§‡ßç‡¶¨‡¶æ‡¶¨‡¶ß‡¶æ‡¶®‡ßá ‡¶™‡ßã‡¶≤</h3>
            <p id="supervisedPolls">0</p>
          </article>
        </div>
      </section>
    </main>

    <!-- Footer same as other pages -->
    <footer class="features">
      <div class="feature">
        <div class="feature-icon">üßæ</div>
        <div class="feature-text">
          <h3>‡¶∏‡ßç‡¶¨‡¶ö‡ßç‡¶õ ‡¶™‡ßç‡¶∞‡¶ï‡ßç‡¶∞‡¶ø‡ßü‡¶æ</h3>
          <p>‡¶∏‡¶Æ‡¶∏‡ßç‡¶§ ‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶° ‡¶Ø‡¶æ‡¶ö‡¶æ‡¶á‡¶Ø‡ßã‡¶ó‡ßç‡¶Ø ‡¶ì ‡¶®‡¶ø‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ‡¶Ø‡ßã‡¶ó‡ßç‡¶Ø‡•§</p>
        </div>
      </div>
      <div class="feature">
        <div class="feature-icon">üîí</div>
        <div class="feature-text">
          <h3>‡¶è‡¶®‡ßç‡¶° ‡¶ü‡ßÅ ‡¶è‡¶®‡ßç‡¶° ‡¶è‡¶®‡¶ï‡ßç‡¶∞‡¶ø‡¶™‡¶∂‡¶®</h3>
          <p>‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶ü‡¶ø ‡¶ß‡¶æ‡¶™‡ßá ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶§‡¶•‡ßç‡¶Ø ‡¶∏‡ßÅ‡¶∞‡¶ï‡ßç‡¶∑‡¶ø‡¶§ ‡¶•‡¶æ‡¶ï‡ßá‡•§</p>
        </div>
      </div>
      <div class="feature">
        <div class="feature-icon">‚ö°</div>
        <div class="feature-text">
          <h3>‡¶¶‡ßç‡¶∞‡ßÅ‡¶§ ‡¶ì ‡¶ï‡¶æ‡¶∞‡ßç‡¶Ø‡¶ï‡¶∞</h3>
          <p>‡¶∞‡¶ø‡ßü‡ßá‡¶≤ ‡¶ü‡¶æ‡¶á‡¶Æ‡ßá ‡¶´‡¶≤‡¶æ‡¶´‡¶≤ ‡¶¶‡ßá‡¶ñ‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡¶¨‡ßá‡¶®‡•§</p>
        </div>
      </div>

      <div class="nav-arrows">
        <button class="arrow-btn" aria-label="‡¶™‡ßÇ‡¶∞‡ßç‡¶¨‡ßá‡¶∞ ‡¶∏‡ßç‡¶≤‡¶æ‡¶á‡¶°">‚Äπ</button>
        <button class="arrow-btn" aria-label="‡¶™‡¶∞‡¶¨‡¶∞‡ßç‡¶§‡ßÄ ‡¶∏‡ßç‡¶≤‡¶æ‡¶á‡¶°">‚Ä∫</button>
      </div>

      <div class="dots" aria-hidden="true">
        <span class="dot active"></span>
        <span class="dot"></span>
        <span class="dot"></span>
      </div>

      <div class="footer-credit">
        <p>¬© ‡ß®‡ß¶‡ß®‡ß´ <strong>FourA</strong> ‚Äì CampusCast</p>
      </div>
    </footer>
  </div>

  <!-- Supabase client, using your current database -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
<script>
  // EXACTLY your current database
  const SUPABASE_URL = "https://hgxjuxgxgbjjqxxvafhx.supabase.co";
  const SUPABASE_ANON_KEY = "sb_publishable_RqoNSHsQQOhs8dfL0OXsdA_TfeVyZcn";

  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const CC_CURRENT_USER_KEY = "cc_currentUser";

  function getCurrentUser() {
    try {
      const raw = localStorage.getItem(CC_CURRENT_USER_KEY);
      if (!raw) return null;
      return JSON.parse(raw);
    } catch (e) {
      console.error("Failed to parse current user", e);
      return null;
    }
  }

  function ensureSupervisor() {
    const user = getCurrentUser();

    if (!user || user.role !== "supervisor") {
      alert("‡¶∂‡ßÅ‡¶ß‡ßÅ‡¶Æ‡¶æ‡¶§‡ßç‡¶∞ ‡¶∏‡ßÅ‡¶™‡¶æ‡¶∞‡¶≠‡¶æ‡¶á‡¶ú‡¶æ‡¶∞ ‡¶è‡¶á ‡¶™‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤‡ßá ‡¶™‡ßç‡¶∞‡¶¨‡ßá‡¶∂ ‡¶ï‡¶∞‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡¶¨‡ßá‡¶®‡•§");
      window.location.href = "../login/login.html";
      return null;
    }

    const welcome = document.getElementById("welcomeText");
    if (welcome) {
      welcome.textContent = `‡¶∏‡ßç‡¶¨‡¶æ‡¶ó‡¶§‡¶Æ, ${user.name} (Supervisor)‡•§`;
    }

    return user;
  }

  // Small helper to show errors on screen so we can see what is wrong
  function showError(message) {
    let box = document.getElementById("dashboardError");
    if (!box) {
      box = document.createElement("p");
      box.id = "dashboardError";
      box.style.color = "crimson";
      box.style.marginTop = "8px";
      box.style.fontSize = "14px";
      const content = document.querySelector(".content");
      if (content) content.appendChild(box);
    }
    box.textContent = message;
  }

  async function loadDashboard() {
    const user = ensureSupervisor();
    if (!user) return;

    // 1) Elections: total and active
    const { data: elections, error: electionsError } = await supabase
      .from("elections")
      .select("id, status");

    if (electionsError) {
      console.error("Elections error:", electionsError);
      showError("elections ‡¶ü‡ßá‡¶¨‡¶ø‡¶≤ ‡¶™‡ßú‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá: " + electionsError.message);
    }

    const totalElections = elections ? elections.length : 0;
    const activeElections = elections
      ? elections.filter(e => (e.status || "").toLowerCase() === "active").length
      : 0;

    document.getElementById("totalElections").textContent = totalElections;
    document.getElementById("activeElections").textContent = activeElections;

    // 2) Candidates: ‡¶Æ‡ßã‡¶ü ‡¶®‡¶ø‡¶¨‡¶®‡ßç‡¶ß‡¶ø‡¶§ ‡¶™‡ßç‡¶∞‡¶æ‡¶∞‡ßç‡¶•‡ßÄ
    const { data: candidates, error: candidatesError } = await supabase
      .from("candidates")
      .select("id");

    console.log("Candidates data:", candidates);
    console.log("Candidates error:", candidatesError);

    if (candidatesError) {
      showError("candidates ‡¶ü‡ßá‡¶¨‡¶ø‡¶≤ ‡¶™‡ßú‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá: " + candidatesError.message);
    }

    document.getElementById("registeredCandidates").textContent =
      candidates ? candidates.length : 0;

    // 3) Voters: ‡¶Æ‡ßã‡¶ü ‡¶®‡¶ø‡¶¨‡¶®‡ßç‡¶ß‡¶ø‡¶§ ‡¶≠‡ßã‡¶ü‡¶æ‡¶∞
    const { data: voters, error: votersError } = await supabase
      .from("voters")
      .select("id");

    if (votersError) {
      console.error("Voters error:", votersError);
      showError("voters ‡¶ü‡ßá‡¶¨‡¶ø‡¶≤ ‡¶™‡ßú‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá: " + votersError.message);
    }

    document.getElementById("registeredVoters").textContent =
      voters ? voters.length : 0;

    // 4) Polls: supervised by this supervisor
    const { data: polls, error: pollsError } = await supabase
      .from("polls")
      .select("id")
      .eq("supervisor_id", user.id);

    if (pollsError) {
      console.error("Polls error:", pollsError);
      showError("polls ‡¶ü‡ßá‡¶¨‡¶ø‡¶≤ ‡¶™‡ßú‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá: " + pollsError.message);
    }

    document.getElementById("supervisedPolls").textContent =
      polls ? polls.length : 0;
  }

  function logout() {
    localStorage.removeItem(CC_CURRENT_USER_KEY);
    window.location.href = "../index.html";
  }

  // Optional debug helper
  async function testSupabase() {
    const user = ensureSupervisor();
    if (!user) return;

    console.log("Testing Supabase connection as supervisor...");

    const { data: candidates, error } = await supabase
      .from("candidates")
      .select("*");

    console.log("testSupabase candidates data:", candidates);
    console.log("testSupabase candidates error:", error);
  }

  loadDashboard();
  window.testSupabase = testSupabase;
</script>


</body>
</html>
