<!DOCTYPE html>
<html lang="bn">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Supervisor Dashboard | CampusCast</title>
  <link rel="stylesheet" href="../assets/style.css" />
</head>
<body>
  <div class="hands-bg"></div>

  <div class="container">
    <!-- Header same style as login/reg -->
    <header class="site-header">
      <a href="../index.html" class="logo" aria-label="CampusCast ‡¶π‡ßã‡¶Æ‡¶™‡ßá‡¶ú‡ßá ‡¶Ø‡¶æ‡¶®">
        <div class="logo-text">
          <span>CampusCast</span>
          <div class="logo-bars">
            <div class="bar"></div>
            <div class="bar alt"></div>
            <div class="bar"></div>
            <div class="bar alt"></div>
          </div>
        </div>
        <div class="logo-subtitle">‡¶¨‡¶ø‡¶∂‡ßç‡¶¨‡¶¨‡¶ø‡¶¶‡ßç‡¶Ø‡¶æ‡¶≤‡ßü ‡¶á ‡¶≠‡ßã‡¶ü‡¶ø‡¶Ç ‡¶∏‡¶ø‡¶∏‡ßç‡¶ü‡ßá‡¶Æ</div>
      </a>

      <nav class="site-nav">
        <a href="../index.html" class="nav-link">‡¶π‡ßã‡¶Æ</a>
        <a href="totalelection.html" class="nav-link">‡¶Æ‡ßã‡¶ü ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶®</a>
        <a href="create_election.html" class="nav-link">‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶§‡ßà‡¶∞‡¶ø</a>
        <a href="registeredcandidates.html" class="nav-link">‡¶®‡¶ø‡¶¨‡¶®‡ßç‡¶ß‡¶ø‡¶§ ‡¶™‡ßç‡¶∞‡¶æ‡¶∞‡ßç‡¶•‡ßÄ</a>
        <a href="registervoters.html" class="nav-link">‡¶®‡¶ø‡¶¨‡¶®‡ßç‡¶ß‡¶ø‡¶§ ‡¶≠‡ßã‡¶ü‡¶æ‡¶∞</a>
        <button class="login-btn" onclick="logout()">‡¶≤‡¶ó‡¶Ü‡¶â‡¶ü</button>
      </nav>
    </header>

    <main class="main-content supervisor-main">
      <!-- Intro block -->
      <section class="content" style="max-width:720px;">
        <span class="badge">‡¶∏‡ßÅ‡¶™‡¶æ‡¶∞‡¶≠‡¶æ‡¶á‡¶ú‡¶æ‡¶∞ ‡¶™‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤</span>
        <h1>‡¶∏‡ßÅ‡¶™‡¶æ‡¶∞‡¶≠‡¶æ‡¶á‡¶ú‡¶æ‡¶∞ ‡¶°‡ßç‡¶Ø‡¶æ‡¶∂‡¶¨‡ßã‡¶∞‡ßç‡¶°</h1>
        <p class="description" id="welcomeText">
          ‡¶∂‡ßÅ‡¶ß‡ßÅ‡¶Æ‡¶æ‡¶§‡ßç‡¶∞ ‡¶∏‡ßÅ‡¶™‡¶æ‡¶∞‡¶≠‡¶æ‡¶á‡¶ú‡¶æ‡¶∞ ‡¶≤‡¶ó‡¶á‡¶® ‡¶è‡¶∞ ‡¶Æ‡¶æ‡¶ß‡ßç‡¶Ø‡¶Æ‡ßá ‡¶è‡¶á ‡¶™‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤‡ßá ‡¶™‡ßç‡¶∞‡¶¨‡ßá‡¶∂ ‡¶ï‡¶∞‡¶æ ‡¶Ø‡¶æ‡¶¨‡ßá‡•§
        </p>
      </section>

      <!-- Metric cards -->
      <section aria-label="Supervisor overview" style="width:100%; max-width:960px; margin:0 auto;">
        <div class="supervisor-grid">
          <article class="super-card">
            <h3>‡¶Æ‡ßã‡¶ü ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶®</h3>
            <p id="totalElections">0</p>
          </article>

          <article class="super-card">
            <h3>‡¶ö‡¶≤‡¶Æ‡¶æ‡¶® ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® (active)</h3>
            <p id="activeElections">0</p>
          </article>

          <article class="super-card">
            <h3>‡¶Æ‡ßã‡¶ü ‡¶®‡¶ø‡¶¨‡¶®‡ßç‡¶ß‡¶ø‡¶§ ‡¶™‡ßç‡¶∞‡¶æ‡¶∞‡ßç‡¶•‡ßÄ</h3>
            <p id="registeredCandidates">0</p>
          </article>

          <article class="super-card">
            <h3>‡¶Æ‡ßã‡¶ü ‡¶®‡¶ø‡¶¨‡¶®‡ßç‡¶ß‡¶ø‡¶§ ‡¶≠‡ßã‡¶ü‡¶æ‡¶∞</h3>
            <p id="registeredVoters">0</p>
          </article>

          <article class="super-card">
            <h3>‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶§‡¶§‡ßç‡¶§‡ßç‡¶¨‡¶æ‡¶¨‡¶ß‡¶æ‡¶®‡ßá ‡¶™‡ßã‡¶≤</h3>
            <p id="supervisedPolls">0</p>
          </article>
        </div>
      </section>

      <!-- Candidate applications block -->
      <section
        aria-label="Candidate applications"
        style="
          margin-top:32px;
          width:100%;
          max-width:960px;
          margin-left:auto;
          margin-right:auto;
        "
      >
        <div style="
          background:#fff;
          border:1px solid var(--border);
          border-radius:14px;
          box-shadow:0 6px 18px rgba(0,0,0,.08);
          padding:22px;
          width:100%;
        ">
          <div style="display:flex; justify-content:space-between; align-items:flex-start; gap:16px;">
            <div>
              <h2 style="margin:0 0 6px; font-size:20px; font-weight:800; color:var(--ink);">
                ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶®‡ßá ‡¶Ö‡¶Ç‡¶∂‡¶ó‡ßç‡¶∞‡¶π‡¶£‡ßá‡¶∞ ‡¶Ü‡¶¨‡ßá‡¶¶‡¶®‡¶∏‡¶Æ‡ßÇ‡¶π
              </h2>
              <p style="margin:0; font-size:14px; color:#4b5563;">
                ‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶™‡ßç‡¶∞‡¶æ‡¶∞‡ßç‡¶•‡ßÄ‡¶¶‡ßá‡¶∞ ‡¶∏‡¶æ‡¶¨‡¶Æ‡¶ø‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶Ü‡¶¨‡ßá‡¶¶‡¶® ‡¶¶‡ßá‡¶ñ‡¶¨‡ßá‡¶® ‡¶è‡¶¨‡¶Ç ‡¶Ö‡¶®‡ßÅ‡¶Æ‡ßã‡¶¶‡¶® ‡¶¨‡¶æ ‡¶¨‡¶æ‡¶§‡¶ø‡¶≤ ‡¶ï‡¶∞‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡¶¨‡ßá‡¶®‡•§
              </p>
            </div>

            <!-- Filter controls -->
            <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
              <select id="statusFilter" style="
                padding:8px 10px;
                border-radius:999px;
                border:1px solid var(--border);
                font-size:13px;
              ">
                <option value="pending">‡¶∂‡ßÅ‡¶ß‡ßÅ pending (submitted / review)</option>
                <option value="all">‡¶∏‡¶ï‡¶≤ ‡¶Ö‡¶¨‡¶∏‡ßç‡¶•‡¶æ</option>
                <option value="draft">Draft</option>
                <option value="submitted">Submitted</option>
                <option value="under_review">Under review</option>
                <option value="approved">Approved</option>
                <option value="rejected">Rejected</option>
              </select>

              <input
                type="text"
                id="searchInput"
                placeholder="‡¶®‡¶æ‡¶Æ ‡¶¨‡¶æ ‡¶á‡¶Æ‡ßá‡¶á‡¶≤ ‡¶¶‡¶ø‡ßü‡ßá ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßÅ‡¶®"
                style="
                  padding:8px 10px;
                  border-radius:999px;
                  border:1px solid var(--border);
                  font-size:13px;
                "
              />
            </div>
          </div>

          <div id="applicationsContainer" style="margin-top:16px; display:flex; flex-direction:column; gap:12px;">
            <!-- Cards will be injected here -->
            <p id="applicationsEmpty" style="font-size:14px; color:#4b5563; margin:4px 0 0;">
              ‡¶Ü‡¶¨‡ßá‡¶¶‡¶® ‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...
            </p>
          </div>
        </div>
      </section>
    </main>

    <!-- Footer same as other pages -->
    <footer class="features">
      <div class="feature">
        <div class="feature-icon">üßæ</div>
        <div class="feature-text">
          <h3>‡¶∏‡ßç‡¶¨‡¶ö‡ßç‡¶õ ‡¶™‡ßç‡¶∞‡¶ï‡ßç‡¶∞‡¶ø‡ßü‡¶æ</h3>
          <p>‡¶∏‡¶Æ‡¶∏‡ßç‡¶§ ‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶° ‡¶Ø‡¶æ‡¶ö‡¶æ‡¶á‡¶Ø‡ßã‡¶ó‡ßç‡¶Ø ‡¶ì ‡¶®‡¶ø‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ‡¶Ø‡ßã‡¶ó‡ßç‡¶Ø‡•§</p>
        </div>
      </div>
      <div class="feature">
        <div class="feature-icon">üîí</div>
        <div class="feature-text">
          <h3>‡¶è‡¶®‡ßç‡¶° ‡¶ü‡ßÅ ‡¶è‡¶®‡ßç‡¶° ‡¶è‡¶®‡¶ï‡ßç‡¶∞‡¶ø‡¶™‡¶∂‡¶®</h3>
          <p>‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶ü‡¶ø ‡¶ß‡¶æ‡¶™‡ßá ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶§‡¶•‡ßç‡¶Ø ‡¶∏‡ßÅ‡¶∞‡¶ï‡ßç‡¶∑‡¶ø‡¶§ ‡¶•‡¶æ‡¶ï‡ßá‡•§</p>
        </div>
      </div>
      <div class="feature">
        <div class="feature-icon">‚ö°</div>
        <div class="feature-text">
          <h3>‡¶¶‡ßç‡¶∞‡ßÅ‡¶§ ‡¶ì ‡¶ï‡¶æ‡¶∞‡ßç‡¶Ø‡¶ï‡¶∞</h3>
          <p>‡¶∞‡¶ø‡ßü‡ßá‡¶≤ ‡¶ü‡¶æ‡¶á‡¶Æ‡ßá ‡¶´‡¶≤‡¶æ‡¶´‡¶≤ ‡¶¶‡ßá‡¶ñ‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡¶¨‡ßá‡¶®‡•§</p>
        </div>
      </div>

      <div class="nav-arrows">
        <button class="arrow-btn" aria-label="‡¶™‡ßÇ‡¶∞‡ßç‡¶¨‡ßá‡¶∞ ‡¶∏‡ßç‡¶≤‡¶æ‡¶á‡¶°">‚Äπ</button>
        <button class="arrow-btn" aria-label="‡¶™‡¶∞‡¶¨‡¶∞‡ßç‡¶§‡ßÄ ‡¶∏‡ßç‡¶≤‡¶æ‡¶á‡¶°">‚Ä∫</button>
      </div>

      <div class="dots" aria-hidden="true">
        <span class="dot active"></span>
        <span class="dot"></span>
        <span class="dot"></span>
      </div>

      <div class="footer-credit">
        <p>¬© ‡ß®‡ß¶‡ß®‡ß´ <strong>FourA</strong> - CampusCast</p>
      </div>
    </footer>
  </div>

  <!-- Supabase client -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>

  <script>
    /**
     * Supabase config, same as login and candidate pages.
     * @type {string}
     */
    const SUPABASE_URL = "https://hgxjuxgxgbjjqxxvafhx.supabase.co";
    const SUPABASE_ANON_KEY = "sb_publishable_RqoNSHsQQOhs8dfL0OXsdA_TfeVyZcn";

    /**
     * LocalStorage key for logged in user.
     * @type {string}
     */
    const CC_CURRENT_USER_KEY = "cc_currentUser";

    /**
     * Supabase client instance.
     * @type {import('https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js').SupabaseClient}
     */
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    /**
     * @typedef {Object} SupervisorUser
     * @property {string} id
     * @property {string} email
     * @property {string} name
     * @property {"supervisor"|"candidate"|"voter"|"public"} role
     */

    /**
     * @typedef {Object} CandidateApplication
     * @property {string} id
     * @property {string} user_id
     * @property {string|null} election_id
     * @property {string|null} requested_symbol
     * @property {string|null} manifesto
     * @property {boolean} is_approved
     * @property {"draft"|"submitted"|"under_review"|"approved"|"rejected"} status
     * @property {string} created_at
     * @property {string|null} submitted_at
     * @property {string|null} approved_at
     * @property {Object|null} user
     * @property {string} [user.name]
     * @property {string} [user.email]
     * @property {string|null} [user.dept]
     * @property {Object|null} election
     * @property {string} [election.title]
     * @property {string|null} [election.status]
     */

    /**
     * Cached applications list in memory.
     * @type {CandidateApplication[]}
     */
    let candidateApplications = [];

    /**
     * Read current user from localStorage.
     * @returns {SupervisorUser|null}
     */
    function getCurrentUser() {
      try {
        const raw = localStorage.getItem(CC_CURRENT_USER_KEY);
        if (!raw) return null;
        return JSON.parse(raw);
      } catch (e) {
        console.error("Failed to parse current user", e);
        return null;
      }
    }

    /**
     * Ensure the user is a supervisor and update welcome text.
     * Redirect to login page if not.
     * @returns {SupervisorUser|null}
     */
    function ensureSupervisor() {
      const user = getCurrentUser();
      if (!user || user.role !== "supervisor") {
        alert("‡¶∂‡ßÅ‡¶ß‡ßÅ‡¶Æ‡¶æ‡¶§‡ßç‡¶∞ ‡¶∏‡ßÅ‡¶™‡¶æ‡¶∞‡¶≠‡¶æ‡¶á‡¶ú‡¶æ‡¶∞ ‡¶è‡¶á ‡¶™‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤‡ßá ‡¶™‡ßç‡¶∞‡¶¨‡ßá‡¶∂ ‡¶ï‡¶∞‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡¶¨‡ßá‡¶®‡•§");
        window.location.href = "../login/login.html";
        return null;
      }

      const welcome = document.getElementById("welcomeText");
      if (welcome) {
        welcome.textContent = `‡¶∏‡ßç‡¶¨‡¶æ‡¶ó‡¶§‡¶Æ, ${user.name} (Supervisor)‡•§`;
      }
      return user;
    }

    /**
     * Show an error message near the top content.
     * @param {string} message
     * @returns {void}
     */
    function showError(message) {
      let box = document.getElementById("dashboardError");
      if (!box) {
        box = document.createElement("p");
        box.id = "dashboardError";
        box.style.color = "crimson";
        box.style.marginTop = "8px";
        box.style.fontSize = "14px";
        const content = document.querySelector(".content");
        if (content) content.appendChild(box);
      }
      box.textContent = message;
    }

    /**
     * Load top level metrics for supervisor.
     * @param {SupervisorUser} user
     * @returns {Promise<void>}
     */
    async function loadMetrics(user) {
      // Elections
      const { data: elections, error: electionsError } = await supabase
        .from("elections")
        .select("id, status");

      if (electionsError) {
        console.error("Elections error:", electionsError);
        showError("elections ‡¶ü‡ßá‡¶¨‡¶ø‡¶≤ ‡¶™‡ßú‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá: " + electionsError.message);
      }

      const totalElections = elections ? elections.length : 0;
      const activeElections = elections
        ? elections.filter((e) => (e.status || "").toLowerCase() === "active").length
        : 0;

      document.getElementById("totalElections").textContent = totalElections;
      document.getElementById("activeElections").textContent = activeElections;

      // Candidates
      const { data: candidates, error: candidatesError } = await supabase
        .from("candidates")
        .select("id");

      if (candidatesError) {
        console.error("Candidates error:", candidatesError);
        showError("candidates ‡¶ü‡ßá‡¶¨‡¶ø‡¶≤ ‡¶™‡ßú‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá: " + candidatesError.message);
      }

      document.getElementById("registeredCandidates").textContent =
        candidates ? candidates.length : 0;

      // Voters
      const { data: voters, error: votersError } = await supabase
        .from("voters")
        .select("id");

      if (votersError) {
        console.error("Voters error:", votersError);
        showError("voters ‡¶ü‡ßá‡¶¨‡¶ø‡¶≤ ‡¶™‡ßú‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá: " + votersError.message);
      }

      document.getElementById("registeredVoters").textContent =
        voters ? voters.length : 0;

      // Polls supervised by this user
      const { data: polls, error: pollsError } = await supabase
        .from("polls")
        .select("id")
        .eq("supervisor_id", user.id);

      if (pollsError) {
        console.error("Polls error:", pollsError);
        showError("polls ‡¶ü‡ßá‡¶¨‡¶ø‡¶≤ ‡¶™‡ßú‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá: " + pollsError.message);
      }

      document.getElementById("supervisedPolls").textContent =
        polls ? polls.length : 0;
    }

    /**
     * Fetch candidate applications with joined user and election.
     * @returns {Promise<CandidateApplication[]>}
     */
    async function fetchCandidateApplications() {
      const { data, error } = await supabase
        .from("candidates")
        .select(`
          id,
          user_id,
          election_id,
          requested_symbol,
          manifesto,
          is_approved,
          status,
          created_at,
          submitted_at,
          approved_at,
          user:user_id (
            name,
            email,
            dept
          ),
          election:election_id (
            title,
            status
          )
        `)
        .order("created_at", { ascending: false });

      if (error) {
        console.error("Applications fetch error:", error);
        throw new Error("‡¶™‡ßç‡¶∞‡¶æ‡¶∞‡ßç‡¶•‡ßÄ‡¶∞ ‡¶Ü‡¶¨‡ßá‡¶¶‡¶® ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá: " + error.message);
      }
      return data || [];
    }

    /**
     * Convert status to Bangla text.
     * @param {"draft"|"submitted"|"under_review"|"approved"|"rejected"} status
     * @returns {string}
     */
    function statusText(status) {
      switch (status) {
        case "submitted":
          return "‡¶∏‡¶æ‡¶¨‡¶Æ‡¶ø‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá";
        case "under_review":
          return "‡¶™‡¶∞‡ßç‡¶Ø‡¶æ‡¶≤‡ßã‡¶ö‡¶®‡¶æ‡¶ß‡ßÄ‡¶®";
        case "approved":
          return "‡¶Ö‡¶®‡ßÅ‡¶Æ‡ßã‡¶¶‡¶ø‡¶§";
        case "rejected":
          return "‡¶¨‡¶æ‡¶§‡¶ø‡¶≤";
        default:
          return "‡¶°‡ßç‡¶∞‡¶æ‡¶´‡¶ü";
      }
    }

    /**
     * Colors for status pill.
     * @param {"draft"|"submitted"|"under_review"|"approved"|"rejected"} status
     * @returns {{bg: string, color: string}}
     */
    function statusColors(status) {
      switch (status) {
        case "submitted":
        case "under_review":
          return { bg: "#fef3c7", color: "#92400e" };
        case "approved":
          return { bg: "#dcfce7", color: "#166534" };
        case "rejected":
          return { bg: "#fee2e2", color: "#b91c1c" };
        default:
          return { bg: "#e5e7eb", color: "#4b5563" };
      }
    }

    /**
     * Render candidate applications list applying filters.
     * @returns {void}
     */
    function renderApplications() {
      const container = document.getElementById("applicationsContainer");
      const emptyText = document.getElementById("applicationsEmpty");
      const statusFilter = /** @type {HTMLSelectElement} */ (document.getElementById("statusFilter"));
      const searchInput = /** @type {HTMLInputElement} */ (document.getElementById("searchInput"));

      if (!container || !statusFilter || !searchInput) return;

      container.innerHTML = "";
      if (!candidateApplications.length) {
        if (emptyText) {
          emptyText.textContent = "‡¶è‡¶ñ‡¶®‡ßã ‡¶ï‡ßã‡¶®‡ßã ‡¶™‡ßç‡¶∞‡¶æ‡¶∞‡ßç‡¶•‡ßÄ‡¶∞ ‡¶Ü‡¶¨‡ßá‡¶¶‡¶® ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø‡•§";
        }
        return;
      }

      const filterStatus = statusFilter.value;
      const search = searchInput.value.trim().toLowerCase();

      /** @type {CandidateApplication[]} */
      const filtered = candidateApplications.filter((app) => {
        // status filter
        if (filterStatus === "pending") {
          if (app.status !== "submitted" && app.status !== "under_review") {
            return false;
          }
        } else if (filterStatus !== "all") {
          if (app.status !== filterStatus) return false;
        }

        // search filter
        if (search) {
          const name = (app.user?.name || "").toLowerCase();
          const email = (app.user?.email || "").toLowerCase();
          if (!name.includes(search) && !email.includes(search)) {
            return false;
          }
        }
        return true;
      });

      if (!filtered.length) {
        const p = document.createElement("p");
        p.textContent = "‡¶è‡¶á ‡¶´‡¶ø‡¶≤‡ßç‡¶ü‡¶æ‡¶∞ ‡¶Ö‡¶®‡ßÅ‡¶Ø‡¶æ‡ßü‡ßÄ ‡¶ï‡ßã‡¶®‡ßã ‡¶Ü‡¶¨‡ßá‡¶¶‡¶® ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø‡•§";
        p.style.fontSize = "14px";
        p.style.color = "#4b5563";
        container.appendChild(p);
        return;
      }

      filtered.forEach((app) => {
        const card = document.createElement("div");
        card.style.border = "1px solid var(--border)";
        card.style.borderRadius = "12px";
        card.style.padding = "14px 16px";
        card.style.backgroundColor = "#f9fafb";

        const header = document.createElement("div");
        header.style.display = "flex";
        header.style.justifyContent = "space-between";
        header.style.alignItems = "flex-start";
        header.style.marginBottom = "6px";

        const left = document.createElement("div");
        const nameP = document.createElement("p");
        nameP.style.margin = "0 0 2px";
        nameP.style.fontWeight = "700";
        nameP.textContent = app.user?.name || "Unknown candidate";

        const subP = document.createElement("p");
        subP.style.margin = "0";
        subP.style.fontSize = "13px";
        subP.style.color = "#4b5563";
        const dept = app.user?.dept ? " ¬∑ " + app.user.dept : "";
        subP.textContent = (app.user?.email || "no-email") + dept;

        left.appendChild(nameP);
        left.appendChild(subP);

        const pill = document.createElement("span");
        const colors = statusColors(app.status);
        pill.textContent = statusText(app.status);
        pill.style.fontSize = "12px";
        pill.style.fontWeight = "600";
        pill.style.padding = "4px 10px";
        pill.style.borderRadius = "999px";
        pill.style.backgroundColor = colors.bg;
        pill.style.color = colors.color;

        header.appendChild(left);
        header.appendChild(pill);
        card.appendChild(header);

        const electionP = document.createElement("p");
        electionP.style.margin = "4px 0";
        electionP.style.fontSize = "13px";
        electionP.innerHTML =
          "<strong>‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶®:</strong> " +
          (app.election?.title || "‡¶ï‡ßã‡¶®‡ßã ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡¶®‡¶ø");
        card.appendChild(electionP);

        const symbolP = document.createElement("p");
        symbolP.style.margin = "0 0 4px";
        symbolP.style.fontSize = "13px";
        symbolP.innerHTML =
          "<strong>‡¶™‡ßç‡¶∞‡¶§‡ßÄ‡¶ï (requested):</strong> " +
          (app.requested_symbol || app.symbol || "‡¶®‡¶ø‡¶∞‡ßç‡¶ß‡¶æ‡¶∞‡¶ø‡¶§ ‡¶®‡ßü");
        card.appendChild(symbolP);

        if (app.manifesto) {
          const manP = document.createElement("p");
          manP.style.margin = "0 0 6px";
          manP.style.fontSize = "13px";
          manP.innerHTML =
            "<strong>‡¶á‡¶∂‡¶§‡ßá‡¶π‡¶æ‡¶∞:</strong> " + app.manifesto;
          card.appendChild(manP);
        }

        const actionsRow = document.createElement("div");
        actionsRow.style.display = "flex";
        actionsRow.style.justifyContent = "flex-end";
        actionsRow.style.gap = "8px";
        actionsRow.style.marginTop = "6px";

        const approveBtn = document.createElement("button");
        approveBtn.type = "button";
        approveBtn.textContent = "Approve";
        approveBtn.style.padding = "6px 10px";
        approveBtn.style.fontSize = "12px";
        approveBtn.style.borderRadius = "999px";
        approveBtn.style.border = "none";
        approveBtn.style.cursor = "pointer";
        approveBtn.style.backgroundColor = "#16a34a";
        approveBtn.style.color = "#ffffff";

        const rejectBtn = document.createElement("button");
        rejectBtn.type = "button";
        rejectBtn.textContent = "Reject";
        rejectBtn.style.padding = "6px 10px";
        rejectBtn.style.fontSize = "12px";
        rejectBtn.style.borderRadius = "999px";
        rejectBtn.style.border = "none";
        rejectBtn.style.cursor = "pointer";
        rejectBtn.style.backgroundColor = "#b91c1c";
        rejectBtn.style.color = "#ffffff";

        // disable buttons if already final
        if (app.status === "approved" || app.status === "rejected") {
          approveBtn.disabled = true;
          rejectBtn.disabled = true;
          approveBtn.style.opacity = "0.6";
          rejectBtn.style.opacity = "0.6";
          approveBtn.style.cursor = "default";
          rejectBtn.style.cursor = "default";
        }

        approveBtn.addEventListener("click", () => {
          handleStatusChange(app.id, "approved");
        });
        rejectBtn.addEventListener("click", () => {
          handleStatusChange(app.id, "rejected");
        });

        actionsRow.appendChild(approveBtn);
        actionsRow.appendChild(rejectBtn);
        card.appendChild(actionsRow);

        container.appendChild(card);
      });
    }

    /**
     * Update candidate status in Supabase and refresh cached list.
     * @param {string} candidateId
     * @param {"approved"|"rejected"} newStatus
     * @returns {Promise<void>}
     */
    async function handleStatusChange(candidateId, newStatus) {
      const confirmText =
        newStatus === "approved"
          ? "‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ‡¶∏‡¶§‡ßç‡¶Ø‡¶ø ‡¶è‡¶á ‡¶™‡ßç‡¶∞‡¶æ‡¶∞‡ßç‡¶•‡ßÄ‡¶ï‡ßá approve ‡¶ï‡¶∞‡¶§‡ßá ‡¶ö‡¶æ‡¶®?"
          : "‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ‡¶∏‡¶§‡ßç‡¶Ø‡¶ø ‡¶è‡¶á ‡¶™‡ßç‡¶∞‡¶æ‡¶∞‡ßç‡¶•‡ßÄ‡¶ï‡ßá reject ‡¶ï‡¶∞‡¶§‡ßá ‡¶ö‡¶æ‡¶®?";
      if (!window.confirm(confirmText)) return;

      const approved = newStatus === "approved";
      const payload = {
        status: newStatus,
        is_approved: approved,
        approved_at: new Date().toISOString()
      };

      const { error } = await supabase
        .from("candidates")
        .update(payload)
        .eq("id", candidateId);

      if (error) {
        console.error("Status update error:", error);
        alert("‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶∏ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá: " + error.message);
        return;
      }

      // update cached item
      candidateApplications = candidateApplications.map((app) =>
        app.id === candidateId
          ? { ...app, ...payload }
          : app
      );

      renderApplications();
    }

    /**
     * Logout and go back to home.
     * @returns {void}
     */
    function logout() {
      localStorage.removeItem(CC_CURRENT_USER_KEY);
      window.location.href = "../index.html";
    }

    /**
     * Initialize full supervisor dashboard.
     * @returns {Promise<void>}
     */
    async function initSupervisorDashboard() {
      const user = ensureSupervisor();
      if (!user) return;

      await loadMetrics(user);

      const statusFilter = document.getElementById("statusFilter");
      const searchInput = document.getElementById("searchInput");

      if (statusFilter) {
        statusFilter.addEventListener("change", renderApplications);
      }
      if (searchInput) {
        searchInput.addEventListener("input", renderApplications);
      }

      try {
        candidateApplications = await fetchCandidateApplications();
      } catch (err) {
        showError(err.message || "‡¶™‡ßç‡¶∞‡¶æ‡¶∞‡ßç‡¶•‡ßÄ‡¶∞ ‡¶Ü‡¶¨‡ßá‡¶¶‡¶® ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶§‡ßá ‡¶¨‡ßç‡¶Ø‡¶∞‡ßç‡¶• ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§");
        candidateApplications = [];
      }

      renderApplications();
    }

    // Run on load
    initSupervisorDashboard();
  </script>
</body>
</html>
