<script>
  const SUPABASE_URL = "https://hgxjuxgxgbjjqxxvafhx.supabase.co";
  const SUPABASE_ANON_KEY = "sb_publishable_RqoNSHsQQOhs8dfL0OXsdA_TfeVyZcn";

  // Create Supabase client
  const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const CURRENT_USER_KEY = "cc_currentUser";

  function getCurrentUser() {
    try {
      const rawUserData = localStorage.getItem(CURRENT_USER_KEY);
      if (!rawUserData) return null;
      return JSON.parse(rawUserData);
    } catch {
      return null;
    }
  }

  function logout() {
    localStorage.removeItem(CURRENT_USER_KEY);
    window.location.href = "../index.html";
  }

  const createElectionForm = document.getElementById("createElectionForm");
  const statusElement = document.getElementById("status");

  createElectionForm.addEventListener("submit", async (event) => {
    event.preventDefault();
    statusElement.style.color = "crimson";
    statusElement.textContent = "তথ্য যাচাই করা হচ্ছে...";

    const currentUser = getCurrentUser();
    if (!currentUser || currentUser.role !== "supervisor") {
      statusElement.textContent = "শুধুমাত্র Supervisor এই কাজটি করতে পারবেন।";
      return;
    }

    const titleValue = document.getElementById("title").value.trim();
    const descriptionValue = document.getElementById("description").value.trim();
    const startAtValue = document.getElementById("start_at").value || null;
    const endAtValue = document.getElementById("end_at").value || null;

    if (!titleValue) {
      statusElement.textContent = "শিরোনাম লিখতে হবে।";
      return;
    }

    const { error } = await supabaseClient
      .from("elections")
      .insert([
        {
          title: titleValue,
          description: descriptionValue,
          start_at: startAtValue,   // DB field must stay snake_case
          end_at: endAtValue,       // DB field must stay snake_case
          status: "scheduled",
          created_by: currentUser.id // DB column stays snake_case
        }
      ]);

    if (error) {
      console.error("Create election error:", error);
      statusElement.style.color = "crimson";
      statusElement.textContent = "নির্বাচন তৈরি ব্যর্থ হয়েছে। আবার চেষ্টা করুন।";
      return;
    }

    statusElement.style.color = "green";
    statusElement.textContent = "নির্বাচন সফলভাবে তৈরি হয়েছে।";
    createElectionForm.reset();
  });
</script>
